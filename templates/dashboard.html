{% extends "base.html" %}

{% block title %}Email Guardian - Session {{ session.session_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Session Dashboard</h1>
                <p class="text-muted">{{ session.filename }} - {{ session.created_at[:19] }}</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('case_management', session_id=session.session_id) }}" 
                   class="btn btn-primary">
                    <i class="fas fa-list me-2"></i>View Cases
                </a>
                <a href="{{ url_for('escalation_dashboard', session_id=session.session_id) }}" 
                   class="btn btn-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Escalations
                    <span class="badge bg-white text-danger ms-1">
                        {{ processed_data|selectattr('status', 'equalto', 'Escalated')|list|length }}
                    </span>
                </a>
                <a href="{{ url_for('export_session', session_id=session.session_id) }}" 
                   class="btn btn-outline-success">
                    <i class="fas fa-download me-2"></i>Export Data
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Sessions
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Session Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ processed_data|length }}</h5>
                        <p class="card-text text-muted">Total Emails</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">
                            {{ processed_data|selectattr('ml_risk_level', 'equalto', 'Critical')|list|length }}
                        </h5>
                        <p class="card-text text-muted">Critical Risk</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">
                            {{ processed_data|selectattr('rule_results.matched_rules')|list|length }}
                        </h5>
                        <p class="card-text text-muted">Rule Matches</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">
                            {{ processed_data|selectattr('rule_results.escalate', 'equalto', true)|list|length }}
                        </h5>
                        <p class="card-text text-muted">Escalations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ML Insights -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Risk Level Distribution</h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="riskChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Domain Classification</h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="domainChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ML Insights Panel -->
{% if ml_insights %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i>ML Analysis Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Anomaly Detection</h6>
                        <p class="text-muted">
                            {{ ml_insights.anomaly_summary.high_anomaly_count }} high-anomaly emails detected
                            ({{ "%.1f"|format(ml_insights.anomaly_summary.anomaly_percentage) }}%)
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Pattern Analysis</h6>
                        <p class="text-muted">
                            {{ ml_insights.pattern_summary.total_patterns }} patterns found,
                            {{ ml_insights.pattern_summary.critical_patterns }} critical
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Recommendations</h6>
                        {% if ml_insights.recommendations %}
                            <ul class="list-unstyled">
                                {% for rec in ml_insights.recommendations[:2] %}
                                <li><small>â€¢ {{ rec }}</small></li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No specific recommendations</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


{% endblock %}

{% block scripts %}
<script>
// Risk Level Chart
const riskCtx = document.getElementById('riskChart').getContext('2d');
const riskData = {
    {% set risk_counts = {} %}
    {% for record in processed_data %}
        {% set risk_level = record.ml_risk_level or 'Low' %}
        {% if risk_counts.update({risk_level: risk_counts.get(risk_level, 0) + 1}) %}{% endif %}
    {% endfor %}
    labels: [{% for level in ['Low', 'Medium', 'High', 'Critical'] %}'{{ level }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for level in ['Low', 'Medium', 'High', 'Critical'] %}{{ risk_counts.get(level, 0) }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
    }]
};

new Chart(riskCtx, {
    type: 'doughnut',
    data: riskData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Domain Classification Chart
const domainCtx = document.getElementById('domainChart').getContext('2d');
const domainData = {
    {% set domain_counts = {} %}
    {% for record in processed_data %}
        {% set domain_class = record.domain_classification or 'Unknown' %}
        {% if domain_counts.update({domain_class: domain_counts.get(domain_class, 0) + 1}) %}{% endif %}
    {% endfor %}
    labels: [{% for class in domain_counts.keys() %}'{{ class }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for count in domain_counts.values() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd']
    }]
};

new Chart(domainCtx, {
    type: 'pie',
    data: domainData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    font: {
                        size: 11
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}