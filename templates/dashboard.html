{% extends "base.html" %}

{% block title %}Email Guardian - Session {{ session.session_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Session Dashboard</h1>
                <p class="text-muted">{{ session.filename }} - {{ session.created_at[:19] }}</p>
            </div>
            <div class="btn-group">
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-chart-bar me-2"></i>Analytics Views
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('whitelist_analysis', session_id=session.session_id) }}">
                            <i class="fas fa-shield-alt me-2"></i>Whitelist Analysis
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('time_analysis', session_id=session.session_id) }}">
                            <i class="fas fa-clock me-2"></i>Time Analysis
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('sender_analysis', session_id=session.session_id) }}">
                            <i class="fas fa-users me-2"></i>Sender Analysis
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="scrollToSection('additional-analytics')">
                            <i class="fas fa-arrow-down me-2"></i>View All Charts
                        </a></li>
                    </ul>
                </div>
                <a href="{{ url_for('export_session', session_id=session.session_id) }}" 
                   class="btn btn-outline-success">
                    <i class="fas fa-download me-2"></i>Export Data
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Sessions
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Session Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ case_management_count + escalated_count }}</h5>
                        <p class="card-text text-muted">Total Emails</p>
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            {{ session.whitelist_filtered or 0 }} whitelisted
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <a href="{{ url_for('case_management', session_id=session.session_id, risk_filter='Critical') }}" class="text-decoration-none">
            <div class="card stats-card clickable-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title mb-0">
                                {{ ml_insights.risk_distribution.get('Critical', 0) }}
                            </h5>
                            <p class="card-text text-muted">Critical Risk</p>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">
                            {{ escalated_count }}
                        </h5>
                        <p class="card-text text-muted">Rule Matches</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <a href="{{ url_for('escalation_dashboard', session_id=session.session_id) }}" class="text-decoration-none">
            <div class="card stats-card clickable-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-success">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title mb-0">
                                {{ escalated_count }}
                            </h5>
                            <p class="card-text text-muted">Escalations</p>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Risk Level Breakdown -->
<div class="row mb-4">
    <div class="col-md-4">
        <a href="{{ url_for('case_management', session_id=session.session_id, risk_filter='High') }}" class="text-decoration-none">
            <div class="card stats-card clickable-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title mb-0">
                                {{ ml_insights.risk_distribution.get('High', 0) }}
                            </h5>
                            <p class="card-text text-muted">High Risk</p>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-4">
        <a href="{{ url_for('case_management', session_id=session.session_id, risk_filter='Medium') }}" class="text-decoration-none">
            <div class="card stats-card clickable-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-info">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title mb-0">
                                {{ ml_insights.risk_distribution.get('Medium', 0) }}
                            </h5>
                            <p class="card-text text-muted">Medium Risk</p>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-4">
        <a href="{{ url_for('case_management', session_id=session.session_id, risk_filter='Low') }}" class="text-decoration-none">
            <div class="card stats-card clickable-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-secondary">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title mb-0">
                                {{ ml_insights.risk_distribution.get('Low', 0) }}
                            </h5>
                            <p class="card-text text-muted">Low Risk</p>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Processing Summary -->
{% if processing_steps %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Processing Summary
                </h5>
            </div>


<!-- Attachment Risk Intelligence Widget -->
<div class="col-md-6">
    <div class="card border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-shield-virus"></i> Attachment Risk Intelligence
            </h5>
        </div>
        <div class="card-body">
            <canvas id="attachmentRiskChart" width="400" height="300"></canvas>
            <div class="mt-3">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border-end">
                            <h6 class="text-danger" id="criticalAttachments">0</h6>
                            <small class="text-muted">Critical Risk</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h6 class="text-warning" id="highRiskAttachments">0</h6>
                            <small class="text-muted">High Risk</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h6 class="text-info" id="avgRiskScore">0.0</h6>
                        <small class="text-muted">Avg Risk Score</small>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Top Risk Factors:</h6>
                <ul id="topRiskFactors" class="list-unstyled">
                    <li><small class="text-muted">Loading risk analysis...</small></li>
                </ul>
            </div>
        </div>
    </div>
</div>


            <div class="card-body">
                <div class="processing-summary">
                    {% for step in processing_steps %}
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>{{ step }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ML Insights -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Risk Level Distribution</h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="riskChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Domain Classification</h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="domainChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics Row -->
<div class="row mb-4" id="additional-analytics">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Whitelisted Domains Analysis
                </h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="whitelistChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-paperclip me-2"></i>Attachment Analysis
                </h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="attachmentChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Time & Volume Analytics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Time Distribution
                </h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="timeChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Top Senders & Recipients
                </h5>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="sendersChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Whitelist Impact
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-success">{{ session.whitelist_filtered or 0 }}</h4>
                            <small class="text-muted">Filtered Emails</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-primary">{{ case_management_count + escalated_count }}</h4>
                            <small class="text-muted">Analyzed Emails</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="progress mb-2">
                    {% set total_emails = (session.whitelist_filtered or 0) + case_management_count + escalated_count %}
                    {% set filtered_pct = ((session.whitelist_filtered or 0) / total_emails * 100) if total_emails > 0 else 0 %}
                    <div class="progress-bar bg-success" style="width: {{ filtered_pct }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format(filtered_pct) }}% emails filtered by whitelist</small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>Data Quality
                </h5>
            </div>
            <div class="card-body">
                {% set complete_records = (case_management_data + escalated_data) | selectattr('sender') | selectattr('recipient') | list | length %}
                {% set total_records = case_management_count + escalated_count %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Complete Records:</span>
                        <span class="badge bg-success">{{ complete_records }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Records:</span>
                        <span class="badge bg-primary">{{ total_records }}</span>
                    </div>
                </div>
                <div class="progress mb-2">
                    {% set quality_pct = (complete_records / total_records * 100) if total_records > 0 else 0 %}
                    <div class="progress-bar bg-success" style="width: {{ quality_pct }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format(quality_pct) }}% data completeness</small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Processing Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Processing Time:</span>
                        <span class="badge bg-info">{{ session.processing_time or 'N/A' }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ML Analysis:</span>
                        <span class="badge bg-success">
                            {% if ml_insights %}Complete{% else %}Pending{% endif %}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Rules Applied:</span>
                        <span class="badge bg-warning">{{ escalated_count }}</span>
                    </div>
                </div>
                <small class="text-muted">Session created: {{ session.created_at[:10] }}</small>
            </div>
        </div>
    </div>
</div>

<!-- ML Insights Panel -->
{% if ml_insights %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i>ML Analysis Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- ML Insights Section -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5><i class="fas fa-brain"></i> ML Analysis Insights</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <small class="text-muted">Risk Distribution</small>
                                        {% if ml_insights.risk_distribution %}
                                            {% for risk, count in ml_insights.risk_distribution.items() %}
                                                <div class="d-flex justify-content-between">
                                                    <span class="badge badge-{{ 'danger' if risk == 'Critical' else 'warning' if risk == 'High' else 'info' if risk == 'Medium' else 'success' }}">{{ risk }}</span>
                                                    <span>{{ count }}</span>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No risk data available</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <small class="text-muted">Anomalies</small>
                                        <div class="d-flex justify-content-between">
                                            <span>High Anomaly Count:</span>
                                            <span class="badge badge-warning">{{ ml_insights.anomaly_summary.high_anomaly_count }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Anomaly %:</span>
                                            <span>{{ "%.1f"|format(ml_insights.anomaly_summary.anomaly_percentage) }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">Patterns Detected</small>
                                <div class="d-flex justify-content-between">
                                    <span>Total Patterns:</span>
                                    <span class="badge badge-info">{{ ml_insights.pattern_summary.total_patterns }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Critical Patterns:</span>
                                    <span class="badge badge-danger">{{ ml_insights.pattern_summary.critical_patterns }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>High Patterns:</span>
                                    <span class="badge badge-warning">{{ ml_insights.pattern_summary.high_patterns }}</span>
                                </div>
                            </div>

                            {% if ml_insights.recommendations %}
                                <div class="mt-3">
                                    <small class="text-muted">Recommendations</small>
                                    {% for rec in ml_insights.recommendations %}
                                        <div class="alert alert-info alert-sm">{{ rec }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- BAU Analysis Section -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-exchange-alt"></i> BAU Email Analysis</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshBAUAnalysis()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="bau-loading" class="text-center" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Analyzing BAU patterns...
                            </div>
                            <div id="bau-content">
                                {% if ml_insights.bau_analysis %}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <small class="text-muted">BAU Statistics</small>
                                                <div class="d-flex justify-content-between">
                                                    <span>BAU Candidates:</span>
                                                    <span class="badge badge-success">{{ ml_insights.bau_analysis.bau_candidates_count }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>BAU Percentage:</span>
                                                    <span>{{ "%.1f"|format(ml_insights.bau_analysis.bau_percentage) }}%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <small class="text-muted">Volume Analysis</small>
                                                <div class="d-flex justify-content-between">
                                                    <span>High Volume Pairs:</span>
                                                    <span class="badge badge-info">{{ ml_insights.bau_analysis.high_volume_pairs|length }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Unique Domains:</span>
                                                    <span>{{ ml_insights.bau_analysis.unique_domain_pairs }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {% if ml_insights.bau_analysis.bau_candidates %}
                                        <div class="mt-3">
                                            <small class="text-muted">Whitelist Candidates</small>
                                            <div class="bau-candidates-list" style="max-height: 200px; overflow-y: auto;">
                                                {% for candidate in ml_insights.bau_analysis.bau_candidates[:5] %}
                                                    <div class="border rounded p-2 mb-2 bg-light">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>{{ candidate.domain_pair }}</strong>
                                                                <br>
                                                                <small class="text-muted">{{ candidate.volume }} emails</small>
                                                            </div>
                                                            <div>
                                                                <span class="badge badge-{{ 'success' if candidate.confidence == 'Very High' else 'warning' if candidate.confidence == 'High' else 'info' }}">
                                                                    {{ candidate.confidence }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">{{ candidate.recommendation }}</small>
                                                    </div>
                                                {% endfor %}
                                            </div>

                                            {% if ml_insights.bau_analysis.bau_candidates|length > 0 %}
                                                <div class="mt-3">
                                                    <button class="btn btn-success btn-sm" onclick="showBAUModal()">
                                                        <i class="fas fa-plus"></i> View All & Whitelist
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-center text-muted">
                                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                                        <p>No BAU analysis available yet</p>
                                        <button class="btn btn-primary btn-sm" onclick="refreshBAUAnalysis()">
                                            Run BAU Analysis
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="col-md-4">
                        <h6>Anomaly Detection</h6>
                        <p class="text-muted">
                            {{ ml_insights.anomaly_summary.high_anomaly_count }} high-anomaly emails detected
                            ({{ "%.1f"|format(ml_insights.anomaly_summary.anomaly_percentage) }}%)
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Pattern Analysis</h6>
                        <p class="text-muted">
                            {{ ml_insights.pattern_summary.total_patterns }} patterns found,
                            {{ ml_insights.pattern_summary.critical_patterns }} critical
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6>Recommendations</h6>
                        {% if ml_insights.recommendations %}
                            <ul class="list-unstyled">
                                {% for rec in ml_insights.recommendations[:2] %}
                                <li><small>â€¢ {{ rec }}</small></li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No specific recommendations</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4>Data Analysis Tools</h4>
                <p class="text-muted mb-0">Use these tools to analyze and debug your uploaded data</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="reprocessRules()">
                    <i class="fas fa-sync-alt me-2"></i>Reprocess Rules
                </button>
                <button class="btn btn-outline-info ms-2" onclick="debugData()">
                    <i class="fas fa-bug me-2"></i>Debug Data
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Risk Level Chart
const riskCtx = document.getElementById('riskChart').getContext('2d');
const riskData = {
    {% set risk_counts = {} %}
    {% for record in case_management_data + escalated_data %}
        {% set risk_level = record.ml_risk_level or 'Low' %}
        {% if risk_counts.update({risk_level: risk_counts.get(risk_level, 0) + 1}) %}{% endif %}
    {% endfor %}
    labels: [{% for level in ['Low', 'Medium', 'High', 'Critical'] %}'{{ level }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for level in ['Low', 'Medium', 'High', 'Critical'] %}{{ risk_counts.get(level, 0) }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
    }]
};

new Chart(riskCtx, {
    type: 'doughnut',
    data: riskData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Domain Classification Chart
const domainCtx = document.getElementById('domainChart').getContext('2d');
const domainData = {
    {% set domain_counts = {} %}
    {% for record in case_management_data + escalated_data %}
        {% set domain_class = record.domain_classification or 'Unknown' %}
        {% if domain_counts.update({domain_class: domain_counts.get(domain_class, 0) + 1}) %}{% endif %}
    {% endfor %}
    labels: [{% for class in domain_counts.keys() %}'{{ class }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for count in domain_counts.values() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd']
    }]
};

new Chart(domainCtx, {
    type: 'pie',
    data: domainData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    font: {
                        size: 11
                    }
                }
            }
        }
    }
});

// Whitelist Analysis Chart
const whitelistCtx = document.getElementById('whitelistChart').getContext('2d');
const whitelistData = {
    labels: ['Filtered (Whitelist)', 'Analyzed'],
    datasets: [{
        data: [{{ session.whitelist_filtered or 0 }}, {{ case_management_count + escalated_count }}],
        backgroundColor: ['#28a745', '#007bff']
    }]
};

new Chart(whitelistCtx, {
    type: 'doughnut',
    data: whitelistData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Attachment Analysis Chart
const attachmentCtx = document.getElementById('attachmentChart').getContext('2d');
const attachmentData = {
    {% set attachment_counts = {} %}
    {% for record in case_management_data + escalated_data %}
        {% set attachment_class = record.attachment_classification or 'No Attachments' %}
        {% if attachment_counts.update({attachment_class: attachment_counts.get(attachment_class, 0) + 1}) %}{% endif %}
    {% endfor %}
    labels: [{% for class in attachment_counts.keys() %}'{{ class }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for count in attachment_counts.values() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8']
    }]
};

new Chart(attachmentCtx, {
    type: 'pie',
    data: attachmentData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    font: {
                        size: 11
                    }
                }
            }
        }
    }
});

// Time Distribution Chart
const timeCtx = document.getElementById('timeChart').getContext('2d');
const timeData = {
    {% set hour_counts = {} %}
    {% for record in case_management_data + escalated_data %}
        {% if record.sent_timestamp %}
            {% set hour = record.sent_timestamp.split('T')[1].split(':')[0] if 'T' in record.sent_timestamp else record.sent_timestamp.split(' ')[1].split(':')[0] if ' ' in record.sent_timestamp else '00' %}
            {% if hour_counts.update({hour: hour_counts.get(hour, 0) + 1}) %}{% endif %}
        {% endif %}
    {% endfor %}
    labels: [{% for hour in range(24) %}'{{ "%02d"|format(hour) }}:00'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Emails Sent',
        data: [{% for hour in range(24) %}{{ hour_counts.get("%02d"|format(hour), 0) }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: '#007bff',
        borderColor: '#007bff',
        borderWidth: 1
    }]
};

new Chart(timeCtx, {
    type: 'bar',
    data: timeData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Top Senders Chart
const sendersCtx = document.getElementById('sendersChart').getContext('2d');
const sendersData = {
    {% set sender_counts = {} %}
    {% for record in case_management_data + escalated_data %}
        {% if record.sender %}
            {% set sender = record.sender.split('@')[0] if '@' in record.sender else record.sender %}
            {% if sender_counts.update({sender: sender_counts.get(sender, 0) + 1}) %}{% endif %}
        {% endif %}
    {% endfor %}
    {% set top_senders = sender_counts.items() | sort(attribute='1', reverse=True) | list %}
    labels: [{% for sender, count in top_senders[:5] %}'{{ sender }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Email Count',
        data: [{% for sender, count in top_senders[:5] %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
    }]
};

new Chart(sendersCtx, {
    type: 'bar',
    data: sendersData,
    options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});
</script>
<script>
    function reprocessRules() {
        if (confirm('This will reprocess all rules and update escalations. Continue?')) {
            const sessionId = '{{ session.session_session_id }}';

            fetch(`/api/reprocess_rules/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Successfully reprocessed: ${data.escalated_count} escalations, ${data.case_management_count} case management records`, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error reprocessing rules', 'error');
            });
        }
    }

    function debugData() {
        const sessionId = '{{ session.session_id }}';

        fetch(`/api/debug_data/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.debug_records) {
                console.log('=== DEBUG DATA ===');
                console.log('Business Keywords:', data.business_keywords);
                console.log('Personal Keywords:', data.personal_keywords);
                console.log('Records:', data.debug_records);

                // Show in alert for easy viewing
                let debugText = 'DEBUG DATA:\n\n';
                debugText += 'Business Keywords: ' + data.business_keywords.join(', ') + '\n\n';
                debugText += 'Records:\n';
                data.debug_records.forEach((record, i) => {
                    debugText += `Record ${i}:\n`;
                    debugText += `  Sender: ${record.sender}\n`;
                    debugText += `  Subject: ${record.subject}\n`;
                    debugText += `  Attachments: ${record.attachments_raw}\n`;
                    debugText += `  Attachment Type: ${record.attachments_type}\n`;
                    debugText += `  Has Attachments: ${record.has_attachments}\n`;
                    debugText += `  Classification: ${record.attachment_classification}\n`;
                    debugText += `  Risk Level: ${record.ml_risk_level}\n\n`;
                });

                alert(debugText);
            } else {
                showNotification(`Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error getting debug data', 'error');
        });
    }

function scrollToSection(sectionId) {
    document.getElementById(sectionId).scrollIntoView({ 
        behavior: 'smooth' 
    });
}
</script>
    <!-- BAU Analysis Modal -->
    <div class="modal fade" id="bauModal" tabindex="-1" aria-labelledby="bauModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bauModalLabel">BAU Email Analysis & Whitelisting</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="bauModalContent">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading BAU analysis...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="whitelistSelectedBtn" onclick="whitelistSelected()" disabled>
                        <i class="fas fa-check"></i> Whitelist Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let bauAnalysisData = null;
        let selectedBauCandidates = [];

        // Auto-refresh dashboard every 30 seconds
        setInterval(function() {
            location.reload();
        }, 30000);

        function refreshBAUAnalysis() {
            const sessionId = '{{ session.session_id if session else "" }}';
            const bauContent = document.getElementById('bau-content');
            const bauLoading = document.getElementById('bau-loading');

            // Check if we have a valid session ID
            if (!sessionId || sessionId.trim() === '') {
                console.log('No session ID available for BAU analysis');
                if (bauContent) {
                    bauContent.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> BAU analysis available after uploading data</div>';
                }
                return;
            }

            if (bauLoading) bauLoading.style.display = 'block';
            if (bauContent) bauContent.style.display = 'none';

            fetch(`/api/bau_analysis/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log('BAU analysis error:', data.error);
                        if (bauContent) {
                            bauContent.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No data available for BAU analysis</div>';
                        }
                    } else {
                        bauAnalysisData = data;
                        updateBAUDisplay(data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching BAU analysis:', error);
                    if (bauContent) {
                        bauContent.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> BAU analysis will be available after uploading data</div>';
                    }
                })
                .finally(() => {
                    if (bauLoading) bauLoading.style.display = 'none';
                    if (bauContent) bauContent.style.display = 'block';
                });
        }

        function updateBAUDisplay(data) {
            const bauContent = document.getElementById('bau-content');
            const stats = data.bau_stats;

            bauContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <small class="text-muted">BAU Statistics</small>
                            <div class="d-flex justify-content-between">
                                <span>BAU Candidates:</span>
                                <span class="badge badge-success">${stats.bau_candidates_count}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>BAU Percentage:</span>
                                <span>${stats.bau_percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <small class="text-muted">Volume Analysis</small>
                            <div class="d-flex justify-content-between">
                                <span>High Volume Pairs:</span>
                                <span class="badge badge-info">${data.high_volume_pairs.length}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Unique Domains:</span>
                                <span>${stats.unique_domain_pairs}</span>
                            </div>
                        </div>
                    </div>
                </div>
                ${data.bau_candidates.length > 0 ? `
                    <div class="mt-3">
                        <small class="text-muted">Top BAU Candidates</small>
                        <div class="bau-candidates-list" style="max-height: 200px; overflow-y: auto;">
                            ${data.bau_candidates.slice(0, 5).map(candidate => `
                                <div class="border rounded p-2 mb-2 bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${candidate.domain_pair}</strong>
                                            <br>
                                            <small class="text-muted">${candidate.volume} emails</small>
                                        </div>
                                        <div>
                                            <span class="badge badge-${candidate.confidence === 'Very High' ? 'success' : candidate.confidence === 'High' ? 'warning' : 'info'}">
                                                ${candidate.confidence}
                                            </span>
                                        </div>
                                    </div>
                                    <small class="text-muted">${candidate.recommendation}</small>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success btn-sm" onclick="showBAUModal()">
                                <i class="fas fa-plus"></i> View All & Whitelist
                            </button>
                        </div>
                    </div>
                ` : '<div class="text-center text-muted mt-3">No BAU candidates found</div>'}
            `;
        }

        function showBAUModal() {
            if (!bauAnalysisData) {
                refreshBAUAnalysis();
                return;
            }

            const modalContent = document.getElementById('bauModalContent');
            const candidates = bauAnalysisData.bau_candidates;

            modalContent.innerHTML = `
                <div class="mb-3">
                    <h6>BAU Email Candidates for Whitelisting</h6>
                    <p class="text-muted">Select domain pairs to add to your whitelist. These represent high-volume, business-related email communications.</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>Domain Pair</th>
                                <th>Volume</th>
                                <th>Confidence</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${candidates.map((candidate, index) => `
                                <tr>
                                    <td>
                                        <input type="checkbox" class="bau-checkbox" data-index="${index}" 
                                               data-pair="${candidate.domain_pair}" onchange="updateWhitelistButton()">
                                    </td>
                                    <td><strong>${candidate.domain_pair}</strong></td>
                                    <td><span class="badge badge-primary">${candidate.volume}</span></td>
                                    <td>
                                        <span class="badge badge-${candidate.confidence === 'Very High' ? 'success' : candidate.confidence === 'High' ? 'warning' : 'info'}">
                                            ${candidate.confidence}
                                        </span>
                                    </td>
                                    <td><small>${candidate.recommendation}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('bauModal'));
            modal.show();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.bau-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });

            updateWhitelistButton();
        }

        function updateWhitelistButton() {
            const checkedBoxes = document.querySelectorAll('.bau-checkbox:checked');
            const whitelistBtn = document.getElementById('whitelistSelectedBtn');

            whitelistBtn.disabled = checkedBoxes.length === 0;
            whitelistBtn.textContent = checkedBoxes.length > 0 ? 
                `Whitelist ${checkedBoxes.length} Selected` : 
                'Whitelist Selected';

            selectedBauCandidates = Array.from(checkedBoxes).map(cb => cb.dataset.pair);
        }

        function whitelistSelected() {
            if (selectedBauCandidates.length === 0) {
                alert('Please select at least one domain pair to whitelist.');
                return;
            }

            const sessionId = '{{ session.session_id }}';
            const whitelistBtn = document.getElementById('whitelistSelectedBtn');

            whitelistBtn.disabled = true;
            whitelistBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            fetch(`/api/whitelist_bau/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    domain_pairs: selectedBauCandidates
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully added ${data.new_domains.length} domains to whitelist!\nNew domains: ${data.new_domains.join(', ')}`);

                    // Close modal and refresh page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bauModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error whitelisting domains. Please try again.');
            })
            .finally(() => {
                whitelistBtn.disabled = false;
                whitelistBtn.innerHTML = '<i class="fas fa-check"></i> Whitelist Selected';
            });
        }

        // Load initial BAU analysis on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshBAUAnalysis();
        });
    </script>
{% endblock %}
</body>
</html>