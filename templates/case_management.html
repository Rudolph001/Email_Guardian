{% extends "base.html" %}

{% block title %}Case Management - {{ session.filename }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">All Sessions</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard', session_id=session.session_id) }}">{{ session.session_id }} Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Case Management</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Case Management</h1>
                <p class="text-muted">{{ session.filename }} - {{ cases|length }} cases</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('dashboard', session_id=session.session_id) }}" 
                   class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
                <a href="{{ url_for('escalation_dashboard', session_id=session.session_id) }}" 
                   class="btn btn-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Escalations
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-2"></i>All Sessions
                </a>
                <button type="button" class="btn btn-outline-warning" onclick="checkProcessingErrors()">
                    <i class="fas fa-exclamation-triangle me-2"></i>Check Errors
                </button>
            </div>
        </div>

        <!-- Error Display Section -->
        <div id="errorSection" class="alert alert-danger" style="display: none;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>Processing Errors Detected
                    </h5>
                    <div id="errorContent"></div>
                </div>
                <button type="button" class="btn-close" onclick="hideErrors()"></button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>Advanced Filters & Search
        </h5>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="false">
            <i class="fas fa-cog me-2"></i>Show All Filters
        </button>
    </div>
    <div class="card-body">
        <form method="GET" id="filterForm">
            <!-- Primary Filters Row -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label for="risk_filter" class="form-label">Risk Level</label>
                    <select name="risk_filter" id="risk_filter" class="form-select">
                        <option value="all" {{ 'selected' if current_filters.risk_filter == 'all' }}>All Risk Levels</option>
                        {% for level in risk_levels %}
                        <option value="{{ level }}" {{ 'selected' if current_filters.risk_filter == level }}>{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="rule_filter" class="form-label">Rule Matches</label>
                    <select name="rule_filter" id="rule_filter" class="form-select">
                        <option value="all" {{ 'selected' if current_filters.rule_filter == 'all' }}>All Cases</option>
                        <option value="matched" {{ 'selected' if current_filters.rule_filter == 'matched' }}>Rule Matched</option>
                        <option value="unmatched" {{ 'selected' if current_filters.rule_filter == 'unmatched' }}>No Rules Matched</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status_filter" class="form-label">Status</label>
                    <select name="status_filter" id="status_filter" class="form-select">
                        <option value="all" {{ 'selected' if current_filters.status_filter == 'all' }}>All Statuses</option>
                        {% for status in statuses %}
                        <option value="{{ status }}" {{ 'selected' if current_filters.status_filter == status }}>{{ status }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="search" class="form-label">Quick Search</label>
                    <div class="input-group">
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search anything..." 
                               value="{{ current_filters.search }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Filters (Collapsible) -->
            <div class="collapse" id="advancedFilters">
                <div class="border-top pt-3">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-sliders-h me-2"></i>Advanced Filters
                    </h6>

                    <!-- Sender & Recipients Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label for="sender_filter" class="form-label">Sender</label>
                            <input type="text" name="sender_filter" id="sender_filter" class="form-control" 
                                   placeholder="Filter by sender email..." 
                                   value="{{ current_filters.sender_filter }}">
                        </div>
                        <div class="col-md-4">
                            <label for="recipient_filter" class="form-label">Recipient</label>
                            <input type="text" name="recipient_filter" id="recipient_filter" class="form-control" 
                                   placeholder="Filter by recipient email..." 
                                   value="{{ current_filters.recipient_filter }}">
                        </div>
                        <div class="col-md-4">
                            <label for="domain_filter" class="form-label">Domain</label>
                            <input type="text" name="domain_filter" id="domain_filter" class="form-control" 
                                   placeholder="Filter by domain..." 
                                   value="{{ current_filters.domain_filter }}">
                        </div>
                    </div>

                    <!-- Subject & Content Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="subject_filter" class="form-label">Subject</label>
                            <input type="text" name="subject_filter" id="subject_filter" class="form-control" 
                                   placeholder="Filter by subject keywords..." 
                                   value="{{ current_filters.subject_filter }}">
                        </div>
                        <div class="col-md-6">
                            <label for="attachment_filter" class="form-label">Attachment Type</label>
                            <select name="attachment_filter" id="attachment_filter" class="form-select">
                                <option value="all" {{ 'selected' if current_filters.attachment_filter == 'all' }}>All Types</option>
                                <option value="has_attachments" {{ 'selected' if current_filters.attachment_filter == 'has_attachments' }}>Has Attachments</option>
                                <option value="no_attachments" {{ 'selected' if current_filters.attachment_filter == 'no_attachments' }}>No Attachments</option>
                                <option value="business" {{ 'selected' if current_filters.attachment_filter == 'business' }}>Business</option>
                                <option value="personal" {{ 'selected' if current_filters.attachment_filter == 'personal' }}>Personal</option>
                                <option value="suspicious" {{ 'selected' if current_filters.attachment_filter == 'suspicious' }}>Suspicious</option>
                                <option value="unknown" {{ 'selected' if current_filters.attachment_filter == 'unknown' }}>Unknown</option>
                            </select>
                        </div>
                    </div>

                    <!-- ML Score & Time Range Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="ml_score_min" class="form-label">Min ML Score</label>
                            <input type="number" name="ml_score_min" id="ml_score_min" class="form-control" 
                                   placeholder="0.0" step="0.1" min="0" max="1"
                                   value="{{ current_filters.ml_score_min }}">
                        </div>
                        <div class="col-md-3">
                            <label for="ml_score_max" class="form-label">Max ML Score</label>
                            <input type="number" name="ml_score_max" id="ml_score_max" class="form-control" 
                                   placeholder="1.0" step="0.1" min="0" max="1"
                                   value="{{ current_filters.ml_score_max }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Date From</label>
                            <input type="date" name="date_from" id="date_from" class="form-control" 
                                   value="{{ current_filters.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Date To</label>
                            <input type="date" name="date_to" id="date_to" class="form-control" 
                                   value="{{ current_filters.date_to }}">
                        </div>
                    </div>

                    <!-- Time & Size Filters Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="time_from" class="form-label">Time From</label>
                            <input type="time" name="time_from" id="time_from" class="form-control" 
                                   value="{{ current_filters.time_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="time_to" class="form-label">Time To</label>
                            <input type="time" name="time_to" id="time_to" class="form-control" 
                                   value="{{ current_filters.time_to }}">
                        </div>
                        <div class="col-md-3">
                            <label for="size_filter" class="form-label">Email Size</label>
                            <select name="size_filter" id="size_filter" class="form-select">
                                <option value="all" {{ 'selected' if current_filters.size_filter == 'all' }}>All Sizes</option>
                                <option value="small" {{ 'selected' if current_filters.size_filter == 'small' }}>Small (&lt;10KB)</option>
                                <option value="medium" {{ 'selected' if current_filters.size_filter == 'medium' }}>Medium (10KB-1MB)</option>
                                <option value="large" {{ 'selected' if current_filters.size_filter == 'large' }}>Large (&gt;1MB)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="has_links" class="form-label">Contains Links</label>
                            <select name="has_links" id="has_links" class="form-select">
                                <option value="all" {{ 'selected' if current_filters.has_links == 'all' }}>All</option>
                                <option value="yes" {{ 'selected' if current_filters.has_links == 'yes' }}>Has Links</option>
                                <option value="no" {{ 'selected' if current_filters.has_links == 'no' }}>No Links</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                <div>
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter me-2"></i>Apply Filters
                    </button>
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>Clear All
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="saveFilters()">
                        <i class="fas fa-save me-2"></i>Save Filters
                    </button>
                </div>
                <div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Showing {{ cases|length }} of {{ total_cases }} cases
                    </small>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Cases Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-envelope me-2"></i>Email Cases ({{ cases|length }})
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="overflow-y: visible !important;">
            <table id="casesTable" class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Date/Time</th>
                        <th>Sender</th>
                        <th>Subject</th>
                        <th>Recipients</th>
                        <th>Risk Level</th>
                        <th>ML Score</th>
                        <th>Attachment Type</th>
                        <th>Rule Matches</th>
                        <th>Status</th>
                        <th class="case-management" style="width: 180px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for case in cases %}
                    {% if case is not none and case is mapping %}
                    <tr>
                        <td>
                            <small class="text-muted">
                                {{ case.get('_time', 'N/A')[:19] if case.get('_time') else 'N/A' }}
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2">
                                    <span class="avatar-title bg-primary rounded-circle">
                                        {{ case.get('sender', 'N/A')[:1].upper() }}
                                    </span>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ case.get('sender', 'N/A') }}</div>
                                    <small class="text-muted">{{ case.get('recipients_email_domain', 'N/A') }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <div class="fw-bold">{{ case.get('subject', 'N/A')[:50] }}{% if case.get('subject', '')|length > 50 %}...{% endif %}</div>
                                {% if case.get('has_attachments') %}
                                <small class="text-warning">
                                    <i class="fas fa-paperclip me-1"></i>Has Attachments
                                </small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div>
                                <div>{{ case.get('recipients', 'N/A')[:30] }}{% if case.get('recipients', '')|length > 30 %}...{% endif %}</div>
                                <small class="text-muted">{{ case.get('department', 'N/A') }}</small>
                            </div>
                        </td>
                        <td>
                            {% set risk_level = case.get('ml_risk_level', 'Unknown') %}
                            {% if risk_level == 'Critical' %}
                            <span class="badge bg-danger">{{ risk_level }}</span>
                            {% elif risk_level == 'High' %}
                            <span class="badge bg-warning">{{ risk_level }}</span>
                            {% elif risk_level == 'Medium' %}
                            <span class="badge bg-info">{{ risk_level }}</span>
                            {% elif risk_level == 'Low' %}
                            <span class="badge bg-success">{{ risk_level }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ risk_level }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ "%.2f"|format(case.get('ml_anomaly_score', 0)) }}
                            </span>
                            {% if case.get('ml_anomaly_score', 0) > 0.7 %}
                                <br><small class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>High Anomaly
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            {% set attachment_type = case.get('attachment_classification', 'Unknown') %}
                            {% if attachment_type == 'Business' %}
                            <span class="badge bg-primary">
                                <i class="fas fa-briefcase me-1"></i>Business
                            </span>
                            {% elif attachment_type == 'Personal' %}
                            <span class="badge bg-warning">
                                <i class="fas fa-user me-1"></i>Personal
                            </span>
                            {% elif attachment_type == 'Mixed' %}
                            <span class="badge bg-info">
                                <i class="fas fa-layer-group me-1"></i>Mixed
                            </span>
                            {% elif attachment_type == 'No Attachments' %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-minus me-1"></i>None
                            </span>
                            {% else %}
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-question me-1"></i>{{ attachment_type }}
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if case.get('rule_results', {}).get('matched_rules') %}
                            <span class="badge bg-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {{ case.get('rule_results', {}).get('matched_rules')|length }} Rules
                            </span>
                            {% else %}
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>Clean
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% set status = case.get('status', 'Active') %}
                            {% if status == 'Active' %}
                            <span class="badge bg-primary">{{ status }}</span>
                            {% elif status == 'Escalated' %}
                            <span class="badge bg-danger">{{ status }}</span>
                            {% elif status == 'Cleared' %}
                            <span class="badge bg-success">{{ status }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ status }}</span>
                            {% endif %}
                        </td>
                        <td class="actions-column">
                            <div class="d-flex gap-1 flex-wrap">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="viewCaseDetails('{{ session.session_id }}', '{{ case.get('record_id', '') }}')"
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" 
                                        onclick="updateCaseStatus('{{ session.session_id }}', '{{ case.get('record_id', '') }}', 'Cleared')"
                                        title="Mark as Cleared">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="escalateCase('{{ session.session_id }}', '{{ case.get('record_id', '') }}')"
                                        title="Escalate">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="updateCaseStatus('{{ session.session_id }}', '{{ case.get('record_id', '') }}', 'Under Review')"
                                        title="Under Review">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            {% if total_pages > 1 %}
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <small class="text-muted">
                        Showing {{ ((page-1) * per_page) + 1 }}-{{ [page * per_page, total_filtered] | min }} of {{ total_filtered }} records
                    </small>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm">
                        {% if has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('case_management', session_id=session.session_id, page=page-1, **current_filters) }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for p in range([1, page-2]|max, [total_pages, page+2]|min + 1) %}
                        <li class="page-item {{ 'active' if p == page else '' }}">
                            <a class="page-link" href="{{ url_for('case_management', session_id=session.session_id, page=p, **current_filters) }}">{{ p }}</a>
                        </li>
                        {% endfor %}

                        {% if has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('case_management', session_id=session.session_id, page=page+1, **current_filters) }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Case Details Modal -->
<div class="modal fade" id="caseDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Case Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="caseDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading case details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportCaseReport()">Export Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Case Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select status...</option>
                            <option value="Active">Active</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Escalated">Escalated</option>
                            <option value="Cleared">Cleared</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" 
                                  placeholder="Add any notes about this status change..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCaseId = null;
let currentSessionId = null;

function viewCaseDetails(sessionId, recordId) {
    currentSessionId = sessionId;
    currentCaseId = recordId;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('caseDetailsModal'));
    modal.show();

    // Load case details
    fetch(`/api/case/${sessionId}/${recordId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            renderCaseDetails(data);
        })
        .catch(error => {
            document.getElementById('caseDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading case details: ${error.message}
                </div>
            `;
        });
}

function renderCaseDetails(caseData) {
    const mlExplanations = caseData.ml_explanations || {};

    const content = `
        <div class="row">
            <!-- Email Information -->
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-envelope me-2"></i>Email Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-12">
                                <strong class="text-primary">From:</strong><br>
                                <span class="text-dark">${caseData.sender || 'N/A'}</span>
                            </div>
                            <div class="col-12">
                                <strong class="text-primary">Subject:</strong><br>
                                <span class="text-dark">${caseData.subject || 'N/A'}</span>
                            </div>
                            <div class="col-12">
                                <strong class="text-primary">To:</strong><br>
                                <span class="text-dark">${caseData.recipients || 'N/A'}</span>
                            </div>
                            <div class="col-6">
                                <strong class="text-primary">Date/Time:</strong><br>
                                <small class="text-muted">${caseData._time || 'N/A'}</small>
                            </div>
                            <div class="col-6">
                                <strong class="text-primary">Department:</strong><br>
                                <small class="text-muted">${caseData.department || 'N/A'}</small>
                            </div>
                            <div class="col-12">
                                <strong class="text-primary">Attachments:</strong><br>
                                ${caseData.has_attachments ? 
                                     `<span class="badge bg-warning"><i class="fas fa-paperclip me-1"></i>Yes</span>
                                      <br><small class="text-muted">${caseData.attachments || 'File names not available'}</small>` : 
                                     '<span class="badge bg-success"><i class="fas fa-check me-1"></i>No attachments</span>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML Risk Assessment -->
            <div class="col-md-6">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>ML Risk Assessment
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <strong class="text-danger">Risk Level:</strong><br>
                                <span class="badge bg-${getRiskBadgeColor(caseData.ml_risk_level)} fs-6">
                                    ${caseData.ml_risk_level || 'Unknown'}
                                </span>
                            </div>
                            <div class="col-6">
                                <strong class="text-danger">Anomaly Score:</strong><br>
                                <span class="badge bg-dark fs-6">
                                    ${caseData.ml_anomaly_score ? (caseData.ml_anomaly_score * 100).toFixed(1) + '%' : 'N/A'}
                                </span>
                            </div>
                            <div class="col-6">
                                <strong class="text-danger">ML Cluster:</strong><br>
                                <span class="badge bg-info">
                                    ${caseData.ml_cluster >= 0 ? '#' + caseData.ml_cluster : 'Unique'}
                                </span>
                            </div>
                            <div class="col-6">
                                <strong class="text-danger">Attachment Type:</strong><br>
                                ${getAttachmentTypeBadge(caseData.attachment_classification)}
                            </div>
                            <div class="col-12">
                                <strong class="text-danger">Domain Type:</strong><br>
                                <span class="badge ${caseData.domain_classification === 'Personal' ? 'bg-warning' : 'bg-success'}">
                                    ${caseData.domain_classification || 'Unknown'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Rule Analysis</h6>
                    </div>
                    <div class="card-body">
                        ${caseData.rule_results && caseData.rule_results.matched_rules ? 
                            `<div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>${caseData.rule_results.matched_rules.length} Rule(s) Matched</strong>
                            </div>
                            <div class="list-group">
                                ${caseData.rule_results.matched_rules.map(rule => `
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">${typeof rule === 'object' ? rule.name || 'Unnamed Rule' : rule}</h6>
                                            ${typeof rule === 'object' && rule.priority ? 
                                                `<span class="badge bg-${rule.priority <= 2 ? 'danger' : rule.priority <= 3 ? 'warning' : 'info'}">
                                                    Priority ${rule.priority}
                                                </span>` : ''}
                                        </div>
                                        ${typeof rule === 'object' && rule.description ? 
                                            `<p class="mb-1 text-muted">${rule.description}</p>` : ''}
                                        ${typeof rule === 'object' && rule.conditions ? 
                                            `<small class="text-muted">
                                                <i class="fas fa-filter me-1"></i>
                                                ${rule.conditions.length} condition(s) matched
                                            </small>` : ''}
                                    </div>
                                `).join('')}
                            </div>` :
                            `<div class="alert alert-success">
                                <i class="fas fa-check me-2"></i>No rules matched - email appears clean
                            </div>`}
                    </div>
                </div>
            </div>

            ${caseData.ml_anomaly_score > 0.7 ? `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            Anomaly Analysis
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-search me-2"></i>
                            <strong>High Anomaly Detected (Score: ${parseFloat(caseData.ml_anomaly_score).toFixed(4)})</strong>
                        </div>
                        ${caseData.anomaly_details ? 
                            caseData.anomaly_details.map(detail => `
                                <div class="mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong class="text-danger">${detail.type || 'Anomaly Detected'}</strong>
                                            <p class="mb-1 text-muted">${detail.description || 'Unusual pattern detected in email data'}</p>
                                            ${detail.field ? `<small class="text-muted"><strong>Field:</strong> ${detail.field}</small>` : ''}
                                        </div>
                                        <span class="badge bg-${detail.severity === 'Critical' ? 'danger' : detail.severity === 'High' ? 'warning' : 'info'}">
                                            ${detail.severity || 'High'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') :
                            `<div class="mb-3 p-3 border rounded bg-light">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    <div>
                                        <strong>Statistical Anomaly</strong>
                                        <p class="mb-0 text-muted">This email shows unusual patterns compared to typical email behavior</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Possible indicators:</strong> Unusual attachment patterns, atypical sending times, 
                                        uncommon recipient combinations, or irregular content structure.
                                    </small>
                                </div>
                            </div>`}
                    </div>
                </div>
            </div>` : ''}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">User Information</h6>
                    </div><div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Department:</strong></td>
                                <td>${caseData.department || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Business Unit:</strong></td>
                                <td>${caseData.bunit || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Account Type:</strong></td>
                                <td>${caseData.account_type || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    <span class="badge bg-${getStatusBadgeColor(caseData.status)}">
                                        ${caseData.status || 'Active'}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        ${caseData.ml_anomaly_score > 0.7 && caseData.anomaly_details ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Anomaly Analysis - High Risk Email
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-search me-2"></i>
                            <strong>High Anomaly Detected (Score: ${parseFloat(caseData.ml_anomaly_score).toFixed(2)})</strong>
                            <br><small>The following anomalies were identified in this email:</small>
                        </div>
                        <div class="row">
                            ${caseData.anomaly_details.map(detail => `
                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-${detail.severity === 'Critical' ? 'danger' : detail.severity === 'High' ? 'warning' : detail.severity === 'Medium' ? 'info' : 'secondary'} mb-0">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>${detail.type}</strong>
                                                <br><small>${detail.description}</small>
                                            </div>
                                            <span class="badge bg-${detail.severity === 'Critical' ? 'danger' : detail.severity === 'High' ? 'warning' : detail.severity === 'Medium' ? 'info' : 'secondary'}">${detail.severity}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>` : ''}

        ${caseData.notes ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Notes</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${caseData.notes}</p>
                    </div>
                </div>
            </div>
        </div>` : ''}

        <!-- ML Analysis Explanations -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-brain me-2"></i>AI Analysis & Explanations
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Risk Analysis -->
                            <div class="col-md-6 mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Risk Analysis
                                    </h6>
                                    ${mlExplanations.risk_analysis ? 
                                        mlExplanations.risk_analysis.map(item => `<p class="mb-1 small">${item}</p>`).join('') : 
                                        '<p class="mb-0 small text-muted">No risk analysis available</p>'
                                    }
                                </div>
                            </div>

                            <!-- Anomaly Factors -->
                            <div class="col-md-6 mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-warning mb-2">
                                        <i class="fas fa-search me-1"></i>Anomaly Factors
                                    </h6>
                                    ${mlExplanations.anomaly_factors ? 
                                        mlExplanations.anomaly_factors.map(item => `<p class="mb-1 small">${item}</p>`).join('') : 
                                        '<p class="mb-0 small text-muted">No anomaly factors identified</p>'
                                    }
                                </div>
                            </div>

                            <!-- Attachment Analysis -->
                            <div class="col-md-6 mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-info mb-2">
                                        <i class="fas fa-paperclip me-1"></i>Attachment Analysis
                                    </h6>
                                    ${mlExplanations.attachment_analysis ? 
                                        mlExplanations.attachment_analysis.map(item => `<p class="mb-1 small">${item}</p>`).join('') : 
                                        '<p class="mb-0 small text-muted">No attachment analysis available</p>'
                                    }
                                </div>
                            </div>

                            <!-- Behavioral Patterns -->
                            <div class="col-md-6 mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-users me-1"></i>Behavioral Patterns
                                    </h6>
                                    ${mlExplanations.behavioral_patterns ? 
                                        mlExplanations.behavioral_patterns.map(item => `<p class="mb-1 small">${item}</p>`).join('') : 
                                        '<p class="mb-0 small text-muted">No behavioral patterns identified</p>'
                                    }
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div class="col-12 mb-3">
                                <div class="bg-success text-white p-3 rounded">
                                    <h6 class="mb-2">
                                        <i class="fas fa-lightbulb me-1"></i>AI Recommendations
                                    </h6>
                                    ${mlExplanations.recommendations ? 
                                        mlExplanations.recommendations.map(item => `<p class="mb-1 small">${item}</p>`).join('') : 
                                        '<p class="mb-0 small">No specific recommendations available</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('caseDetailsContent').innerHTML = content;
}

function getAttachmentTypeBadge(type) {
    switch(type) {
        case 'Business':
            return '<span class="badge bg-primary"><i class="fas fa-briefcase me-1"></i>Business</span>';
        case 'Personal':
            return '<span class="badge bg-warning"><i class="fas fa-user me-1"></i>Personal</span>';
        case 'Mixed':
            return '<span class="badge bg-info"><i class="fas fa-layer-group me-1"></i>Mixed</span>';
        case 'No Attachments':
            return '<span class="badge bg-secondary"><i class="fas fa-minus me-1"></i>None</span>';
        default:
            return '<span class="badge bg-light text-dark"><i class="fas fa-question me-1"></i>Unknown</span>';
    }
}

function getRiskBadgeColor(risk) {
    switch(risk) {
        case 'Critical': return 'danger';
        case 'High': return 'warning';
        case 'Medium': return 'info';
        case 'Low': return 'success';
        default: return 'secondary';
    }
}

function getStatusBadgeColor(status) {
    switch(status) {
        case 'Active': return 'primary';
        case 'Escalated': return 'danger';
        case 'Cleared': return 'success';
        case 'Under Review': return 'warning';
        default: return 'secondary';
    }
}

function updateCaseStatus(sessionId, recordId, newStatus) {
    if (newStatus === 'Clear' && !confirm('Are you sure you want to clear this case?')) {
        return;
    }

    if (newStatus === 'Escalate' && !confirm('Are you sure you want to escalate this case? This will move it to the escalation dashboard.')) {
        return;
    }

    fetch(`/api/case/${sessionId}/${recordId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: newStatus,
            notes: `Status updated to ${newStatus} at ${new Date().toISOString()}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating status: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error updating status: ' + error.message);
    });
}

function escalateCase(sessionId, recordId) {
    if (!confirm('Are you sure you want to escalate this case? This will move it to the escalation dashboard.')) {
        return;
    }

    fetch(`/api/case/${sessionId}/${recordId}/escalate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Case escalated successfully! Redirecting to escalationdashboard...');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                location.reload();
            }
        } else {
            alert('Error escalating case: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error escalating case: ' + error.message);
    });
}

function exportCaseReport() {
    // This would export the current case details
    const caseData = currentCaseId;
    alert('Export functionality would be implemented here');
}

// Filter management functions
function clearFilters() {
    document.getElementById('filterForm').reset();
    // Clear URL parameters and reload
    window.location.href = window.location.pathname;
}

function saveFilters() {
    const filters = {};
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);

    for (let [key, value] of formData.entries()) {
        if (value && value !== 'all') {
            filters[key] = value;
        }
    }

    localStorage.setItem('emailGuardianFilters', JSON.stringify(filters));
    alert('Filters saved successfully!');
}

function loadSavedFilters() {
    const saved = localStorage.getItem('emailGuardianFilters');
    if (saved) {
        const filters = JSON.parse(saved);
        for (const [key, value] of Object.entries(filters)) {
            const element = document.getElementById(key);
            if (element) {
                element.value = value;
            }
        }
    }
}

function checkProcessingErrors() {
    const sessionId = '{{ session.session_id }}';
    
    fetch(`/api/processing_errors/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.processing_failed && data.errors && data.errors.length > 0) {
                displayErrors(data.errors);
            } else {
                // Show success message if no errors
                const errorSection = document.getElementById('errorSection');
                errorSection.className = 'alert alert-success';
                errorSection.style.display = 'block';
                document.getElementById('errorContent').innerHTML = `
                    <p class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        No processing errors found. All data loaded successfully.
                    </p>
                `;
                
                // Auto-hide success message after 3 seconds
                setTimeout(() => {
                    errorSection.style.display = 'none';
                    errorSection.className = 'alert alert-danger';
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error checking processing errors:', error);
            displayErrors([{
                error_type: 'api_error',
                error: `Failed to check errors: ${error.message}`,
                field: 'system',
                value: 'N/A'
            }]);
        });
}

function displayErrors(errors) {
    const errorSection = document.getElementById('errorSection');
    const errorContent = document.getElementById('errorContent');
    
    let errorHtml = `
        <p class="mb-3">
            <strong>Found ${errors.length} processing error(s):</strong>
        </p>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Record</th>
                        <th>Error Type</th>
                        <th>Field</th>
                        <th>Value</th>
                        <th>Error Description</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    errors.forEach((error, index) => {
        errorHtml += `
            <tr>
                <td>${error.record_index || 'Unknown'}</td>
                <td>
                    <span class="badge bg-warning text-dark">
                        ${error.error_type || 'Unknown'}
                    </span>
                </td>
                <td><code>${error.field || 'N/A'}</code></td>
                <td>
                    <small class="text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                        ${error.value || 'N/A'}
                    </small>
                </td>
                <td>${error.error || 'No description'}</td>
            </tr>
        `;
    });
    
    errorHtml += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                These errors occurred during data processing. Records with errors may have incomplete or missing information.
            </small>
        </div>
    `;
    
    errorContent.innerHTML = errorHtml;
    errorSection.style.display = 'block';
}

function hideErrors() {
    document.getElementById('errorSection').style.display = 'none';
}

// Auto-check for errors if no data is loaded
function autoCheckErrors() {
    const casesTable = document.querySelector('#casesTable tbody');
    const totalCases = {{ cases|length }};
    
    if (totalCases === 0) {
        // Automatically check for processing errors if no cases are displayed
        setTimeout(() => {
            checkProcessingErrors();
        }, 1000);
    }
}

// Auto-apply filters on change
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Load saved filters if available
    loadSavedFilters();

    // Auto-submit form on dropdown changes
    const filterSelects = document.querySelectorAll('#filterForm select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            if (this.value !== 'all') {
                document.getElementById('filterForm').submit();
            }
        });
    });

    // Auto-check for errors if needed
    autoCheckErrors();
});
</script>
{% endblock %}