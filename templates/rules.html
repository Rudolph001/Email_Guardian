{% extends "base.html" %}

{% block title %}Email Guardian - Rules{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Rule Management</h1>
            <button class="btn btn-primary" onclick="createRule()">
                <i class="fas fa-plus me-2"></i>Create Rule
            </button>
        </div>
    </div>
</div>

<!-- Rules Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|length }}</h5>
                        <p class="card-text text-muted">Total Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('active', 'equalto', true)|list|length }}</h5>
                        <p class="card-text text-muted">Active Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('priority', 'equalto', 1)|list|length }}</h5>
                        <p class="card-text text-muted">High Priority</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('active', 'equalto', false)|list|length }}</h5>
                        <p class="card-text text-muted">Inactive Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rules List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Processing Rules</h5>
            </div>
            <div class="card-body">
                {% if rules %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Description</th>
                                    <th>Priority</th>
                                    <th>Conditions</th>
                                    <th>Actions</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in rules %}
                                <tr class="{% if not rule.active %}table-secondary{% endif %}">
                                    <td>
                                        <strong>{{ rule.name }}</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ rule.description[:50] + '...' if rule.description and rule.description|length > 50 else rule.description or 'No description' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if rule.priority == 1 else 'warning' if rule.priority == 2 else 'info' }}">
                                            {{ rule.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ rule.conditions|length }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ rule.actions|length }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if rule.active else 'secondary' }}">
                                            {{ 'Active' if rule.active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ rule.created_at[:19] if rule.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                            <div class="d-flex gap-1">
                                <button class="btn btn-outline-primary btn-sm" 
                                        data-rule-id="{{ rule.id }}"
                                        data-rule-name="{{ rule.name }}"
                                        data-rule-description="{{ rule.description or '' }}"
                                        data-rule-conditions='{{ rule.conditions|tojson }}'
                                        data-rule-actions='{{ rule.actions|tojson }}'
                                        data-rule-priority="{{ rule.priority }}"
                                        onclick="viewRuleFromData(this)" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" 
                                        data-rule-id="{{ rule.id }}"
                                        data-rule-name="{{ rule.name }}"
                                        data-rule-description="{{ rule.description or '' }}"
                                        data-rule-conditions='{{ rule.conditions|tojson }}'
                                        data-rule-actions='{{ rule.actions|tojson }}'
                                        data-rule-priority="{{ rule.priority }}"
                                        data-rule-active="{{ rule.active|lower }}"
                                        onclick="editRuleFromData(this)" 
                                        title="Edit Rule">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_rule', rule_id=rule.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this rule?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Rule">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                        <h5>No Rules Configured</h5>
                        <p class="text-muted">Create your first rule to start automated email processing.</p>
                        <button class="btn btn-primary" onclick="createRule()">
                            <i class="fas fa-plus me-2"></i>Create First Rule
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Rule Creation Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_rule') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ruleName" class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="ruleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="rulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="rulePriority" name="priority" required>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3" selected>3 (Medium)</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="ruleDescription" name="description" rows="2"></textarea>
                    </div>

                    <!-- Conditions Builder -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Conditions</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </div>
                        <div id="conditions-container">
                            <!-- Conditions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Add conditions that must be met for this rule to apply</small>
                    </div>

                    <!-- Actions Builder -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Actions</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addAction()">
                                <i class="fas fa-plus me-1"></i>Add Action
                            </button>
                        </div>
                        <div id="actions-container">
                            <!-- Actions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Define what happens when this rule is triggered</small>
                    </div>

                    <!-- Hidden fields for JSON data -->
                    <input type="hidden" id="conditions" name="conditions" value="[]">
                    <input type="hidden" id="actions" name="actions" value="[]">

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ruleActive" name="active" checked>
                        <label class="form-check-label" for="ruleActive">
                            Active Rule
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="buildRuleData()">Create Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rule View Modal -->
<div class="modal fade" id="viewRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rule Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ruleDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Rule Edit Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRuleForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="editRuleName" class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="editRuleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editRulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="editRulePriority" name="priority" required>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3">3 (Medium)</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editRuleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editRuleDescription" name="description" rows="2"></textarea>
                    </div>

                    <!-- Conditions Builder for Edit -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Conditions</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </div>
                        <div id="edit-conditions-container">
                            <!-- Conditions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Add conditions that must be met for this rule to apply</small>
                    </div>

                    <!-- Actions Builder for Edit -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Actions</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addEditAction()">
                                <i class="fas fa-plus me-1"></i>Add Action
                            </button>
                        </div>
                        <div id="edit-actions-container">
                            <!-- Actions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Define what happens when this rule is triggered</small>
                    </div>

                    <!-- Hidden fields for JSON data -->
                    <input type="hidden" id="editConditions" name="conditions" value="[]">
                    <input type="hidden" id="editActions" name="actions" value="[]">

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editRuleActive" name="active">
                        <label class="form-check-label" for="editRuleActive">
                            Active Rule
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="buildEditRuleData()">Update Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conditionCounter = 0;
let actionCounter = 0;
let editConditionCounter = 0;
let editActionCounter = 0;

function createRule() {
    // Reset counters and clear containers
    conditionCounter = 0;
    actionCounter = 0;
    document.getElementById('conditions-container').innerHTML = '';
    document.getElementById('actions-container').innerHTML = '';

    // Add a default condition
    addCondition();
    // Add a default action
    addAction();

    const modal = new bootstrap.Modal(document.getElementById('createRuleModal'));
    modal.show();
}

function addCondition() {
    conditionCounter++;
    const container = document.getElementById('conditions-container');
    const newRow = document.createElement('div');
    newRow.className = 'condition-row mb-2';

    // Show logic dropdown only for conditions after the first one
    const showLogic = conditionCounter > 1;

    newRow.innerHTML = `
        <div class="row align-items-center">
            ${showLogic ? `
            <div class="col-md-1">
                <select class="form-select" name="condition_logic_${conditionCounter}">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
            </div>` : '<div class="col-md-1"></div>'}
            <div class="col-md-4">
                <select class="form-select" name="condition_field_${conditionCounter}" onchange="updateConditionValue(this, ${conditionCounter})">
                    <option value="">Select Field</option>
                    <option value="_time">Time</option>
                    <option value="sender">Sender</option>
                    <option value="subject">Subject</option>
                    <option value="attachments">Attachments</option>
                    <option value="recipients">Recipients</option>
                    <option value="recipients_email_domain">Recipient Domain</option>
                    <option value="leaver">Leaver Status</option>
                    <option value="termination_date">Termination Date</option>
                    <option value="time_month">Time Month</option>
                    <option value="account_type">Account Type</option>
                    <option value="wordlist_attachment">Attachment Wordlist</option>
                    <option value="wordlist_subject">Subject Wordlist</option>
                    <option value="bunit">Business Unit</option>
                    <option value="department">Department</option>
                    <option value="status">Email Status</option>
                    <option value="user_response">User Response</option>
                    <option value="final_outcome">Final Outcome</option>
                    <option value="policy_name">Policy Name</option>
					<option value="justification">Justification</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="condition_operator_${conditionCounter}" onchange="updateConditionOperator(this, ${conditionCounter})">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="in_list">In List (comma-separated)</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="condition_value_${conditionCounter}" placeholder="Value" id="condition_value_${conditionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)" ${conditionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function updateConditionValue(selectElement, conditionId) {
    const fieldType = selectElement.value;
    const valueInput = document.getElementById(`condition_value_${conditionId}`);

    if (fieldType === '_time') {
        valueInput.placeholder = 'Date/time (e.g., 2025-07-18 or 2025-07-18T12:00:00)';
    } else if (fieldType === 'sender') {
        valueInput.placeholder = 'Email address (e.g., user@domain.com)';
    } else if (fieldType === 'subject') {
        valueInput.placeholder = 'Text to match in subject';
    } else if (fieldType === 'attachments') {
        valueInput.placeholder = 'Attachment name or type (e.g., .pdf, document.docx)';
    } else if (fieldType === 'recipients') {
        valueInput.placeholder = 'Recipient email address';
    } else if (fieldType === 'recipients_email_domain') {
        valueInput.placeholder = 'Domain name (e.g., gmail.com)';
    } else if (fieldType === 'leaver') {
        valueInput.placeholder = 'YES or NO';
    } else if (fieldType === 'Termination') {
        valueInput.placeholder = 'Termination date (e.g., 2025-07)';
    } else if (fieldType === 'time_month') {
        valueInput.placeholder = 'Month in YYYY-MM format (e.g., 2025-07)';
    } else if (fieldType === 'account_type') {
        valueInput.placeholder = 'Account type (e.g., employee, contractor)';
    } else if (fieldType === 'wordlist_attachment' || fieldType === 'wordlist_subject') {
        valueInput.placeholder = 'Wordlist match value';
    } else if (fieldType === 'bunit') {
        valueInput.placeholder = 'Business unit (e.g., HR, IT, Finance)';
    } else if (fieldType === 'department') {
        valueInput.placeholder = 'Department name (e.g., Recruitment, Sales)';
    } else if (fieldType === 'status') {
        valueInput.placeholder = 'Email status (e.g., Active, Critical, Blocked)';
    } else if (fieldType === 'user_response') {
        valueInput.placeholder = 'User response value';
    } else if (fieldType === 'final_outcome') {
        valueInput.placeholder = 'Final outcome value';
    } else if (fieldType === 'policy_name') {
        valueInput.placeholder = 'Policy name (e.g., policy_A, policy_B)';
    } else {
        valueInput.placeholder = 'Value';
    }
}

function updateConditionOperator(selectElement, conditionId) {
    updateConditionOperatorHelp(conditionId);
}

function updateConditionOperatorHelp(conditionId) {
    const operatorSelect = document.querySelector(`select[name="condition_operator_${conditionId}"]`);
    const valueHelp = document.getElementById(`condition_value_help_${conditionId}`);

    if (!operatorSelect || !valueHelp) return;

    const operator = operatorSelect.value;

    switch (operator) {
        case 'equals':
            valueHelp.textContent = 'Enter a single value';
            break;
        case 'contains':
            valueHelp.textContent = 'Enter text to search for within the field';
            break;
        case 'not_equals':
            valueHelp.textContent = 'Enter a single value to exclude';
            break;
        case 'in_list':
            valueHelp.textContent = 'Enter multiple values separated by commas (e.g., value1, value2, value3)';
            break;
        default:
            valueHelp.textContent = 'Enter a value';
    }
}

function removeCondition(button) {
    const row = button.closest('.condition-row');
    if (row) {
        row.remove();
        // Update logic display for remaining conditions
        updateConditionLogicDisplay();
    }
}

function updateConditionLogicDisplay() {
    const rows = document.querySelectorAll('.condition-row');
    rows.forEach((row, index) => {
        const logicCol = row.querySelector('.col-md-1:first-child');
        if (index === 0) {
            // First condition shouldn't show logic
            logicCol.innerHTML = '';
        } else {
            // Ensure other conditions have logic selector
            if (!logicCol.querySelector('select')) {
                logicCol.innerHTML = `
                    <select class="form-select" name="condition_logic_${index + 1}">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                `;
            }
        }
    });
}

function addAction() {
    actionCounter++;
    const container = document.getElementById('actions-container');
    const newRow = document.createElement('div');
    newRow.className = 'action-row mb-2';
    newRow.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-5">
                <select class="form-select" name="action_type_${actionCounter}" onchange="updateActionValue(this, ${actionCounter})">
                    <option value="">Select Action</option>
                    <option value="mark_priority">Mark Priority</option>
                    <option value="escalate">Escalate</option>
                    <option value="notify">Notify</option>
                    <option value="block">Block Email</option>
                    <option value="flag">Add Flag</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="action_value_${actionCounter}" placeholder="Action Value" id="action_value_${actionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAction(this)" ${actionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function removeAction(button) {
    const row = button.closest('.action-row');
    if (row) {
        row.remove();
    }
}

function updateActionValue(selectEl, counter) {
    const valueInput = document.getElementById(`action_value_${counter}`);
    const actionType = selectEl.value;

    if (actionType === 'mark_priority') {
        valueInput.placeholder = 'Low, Medium, High, Critical';
    } else if (actionType === 'escalate') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'notify') {
        valueInput.placeholder = 'Notification message';
    } else if (actionType === 'block') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'flag') {
        valueInput.placeholder = 'Flag name';
    } else {
        valueInput.placeholder = 'Action Value';
    }
}

function buildRuleData() {
    const conditions = [];
    const actions = [];

    // Build conditions
    const conditionRows = document.querySelectorAll('.condition-row');
    conditionRows.forEach((row, index) => {
        const fieldEl = row.querySelector(`[name^="condition_field_"]`);
        const operatorEl = row.querySelector(`[name^="condition_operator_"]`);
        const valueEl = row.querySelector(`[name^="condition_value_"]`);
        const logicEl = row.querySelector(`[name^="condition_logic_"]`);

        if (fieldEl && operatorEl && valueEl && fieldEl.value && valueEl.value) {
            const condition = {
                field: fieldEl.value,
                operator: operatorEl.value,
                value: valueEl.value
            };

            // Add logic operator for conditions after the first one
            if (index > 0 && logicEl && logicEl.value) {
                condition.logic = logicEl.value;
            }

            conditions.push(condition);
        }
    });

    // Build actions
    const actionRows = document.querySelectorAll('.action-row');
    actionRows.forEach((row) => {
        const typeEl = row.querySelector(`[name^="action_type_"]`);
        const valueEl = row.querySelector(`[name^="action_value_"]`);

        if (typeEl && valueEl && typeEl.value && valueEl.value) {
            let finalValue = valueEl.value;

            // Convert string boolean to actual boolean
            if (typeEl.value === 'escalate' && 
                (finalValue.toLowerCase() === 'true' || finalValue.toLowerCase() === 'false')) {
                finalValue = finalValue.toLowerCase() === 'true';
            }

            actions.push({
                type: typeEl.value,
                value: finalValue
            });
        }
    });

    // Set hidden fields
    document.getElementById('conditions').value = JSON.stringify(conditions);
    document.getElementById('actions').value = JSON.stringify(actions);
}

function viewRuleFromData(button) {
    try {
        const id = button.dataset.ruleId;
        const name = button.dataset.ruleName;
        const description = button.dataset.ruleDescription;

        // Parse JSON directly since we're using single quotes now
        const conditions = JSON.parse(button.dataset.ruleConditions || '[]');
        const actions = JSON.parse(button.dataset.ruleActions || '[]');
        const priority = button.dataset.rulePriority;

        viewRule(id, name, description, conditions, actions, priority);
    } catch (error) {
        console.error('Error viewing rule:', error);
        console.error('Conditions data:', button.dataset.ruleConditions);
        console.error('Actions data:', button.dataset.ruleActions);
        alert('Error viewing rule: ' + error.message);
    }
}

function editRuleFromData(button) {
    try {
        const id = button.dataset.ruleId;
        const name = button.dataset.ruleName;
        const description = button.dataset.ruleDescription;

        // Parse JSON directly since we're using single quotes now
        const conditions = JSON.parse(button.dataset.ruleConditions || '[]');
        const actions = JSON.parse(button.dataset.ruleActions || '[]');
        const priority = button.dataset.rulePriority;
        const active = button.dataset.ruleActive === 'true';

        editRule(id, name, description, conditions, actions, priority, active);
    } catch (error) {
        console.error('Error editing rule:', error);
        console.error('Conditions data:', button.dataset.ruleConditions);
        console.error('Actions data:', button.dataset.ruleActions);
        alert('Error editing rule: ' + error.message);
    }
}

function viewRule(id, name, description, conditions, actions, priority) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><strong>Rule Name:</strong></h6>
                <p>${name}</p>

                <h6><strong>Description:</strong></h6>
                <p>${description || 'No description provided'}</p>

                <h6><strong>Priority:</strong></h6>
                <p>${priority}</p>
            </div>
            <div class="col-md-6">
                <h6><strong>Conditions:</strong></h6>
                <pre class="bg-light p-2 border rounded">${JSON.stringify(conditions, null, 2)}</pre>

                <h6><strong>Actions:</strong></h6>
                <pre class="bg-light p-2 border rounded">${JSON.stringify(actions, null, 2)}</pre>
            </div>
        </div>
    `;

    document.getElementById('ruleDetailsContent').innerHTML = content;
    const modal = new bootstrap.Modal(document.getElementById('viewRuleModal'));
    modal.show();
}

function editRule(id, name, description, conditions, actions, priority, active) {
    // Reset counters and clear containers
    editConditionCounter = 0;
    editActionCounter = 0;
    document.getElementById('edit-conditions-container').innerHTML = '';
    document.getElementById('edit-actions-container').innerHTML = '';

    // Populate the edit form
    document.getElementById('editRuleName').value = name;
    document.getElementById('editRuleDescription').value = description || '';
    document.getElementById('editRulePriority').value = priority;
    document.getElementById('editRuleActive').checked = active;

    // Build conditions from JSON
    if (conditions && conditions.length > 0) {
        conditions.forEach((condition, index) => {
            addEditCondition();
            populateEditCondition(editConditionCounter, condition, index === 0);
        });
    } else {
        addEditCondition();
    }

    // Build actions from JSON
    if (actions && actions.length > 0) {
        actions.forEach((action) => {
            addEditAction();
            populateEditAction(editActionCounter, action);
        });
    } else {
        addEditAction();
    }

    // Set the form action to update this specific rule
    document.getElementById('editRuleForm').action = `/rules/${id}/update`;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editRuleModal'));
    modal.show();
}

function addEditCondition() {
    editConditionCounter++;
    const container = document.getElementById('edit-conditions-container');
    const newRow = document.createElement('div');
    newRow.className = 'edit-condition-row mb-2';

    // Show logic dropdown only for conditions after the first one
    const showLogic = editConditionCounter > 1;

    newRow.innerHTML = `
        <div class="row align-items-center">
            ${showLogic ? `
            <div class="col-md-1">
                <select class="form-select" name="edit_condition_logic_${editConditionCounter}">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
            </div>` : '<div class="col-md-1"></div>'}
            <div class="col-md-4">
                <select class="form-select" name="edit_condition_field_${editConditionCounter}" onchange="updateEditConditionValue(this, ${editConditionCounter})">
                    <option value="">Select Field</option>
                    <option value="_time">Time</option>
                    <option value="sender">Sender</option>
                    <option value="subject">Subject</option>
                    <option value="attachments">Attachments</option>
                    <option value="recipients">Recipients</option>
                    <option value="recipients_email_domain">Recipient Domain</option>
                    <option value="leaver">Leaver Status</option>
                    <option value="termination_date">Termination Date</option>
                    <option value="time_month">Time Month</option>
                    <option value="account_type">Account Type</option>
                    <option value="wordlist_attachment">Attachment Wordlist</option>
                    <option value="wordlist_subject">Subject Wordlist</option>
                    <option value="bunit">Business Unit</option>
                    <option value="department">Department</option>
                    <option value="status">Email Status</option>
                    <option value="user_response">User Response</option>
                    <option value="final_outcome">Final Outcome</option>
                    <option value="policy_name">Policy Name</option>
					<option value="justification">Justification</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="edit_condition_operator_${editConditionCounter}">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="in_list">In List (comma-separated)</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="edit_condition_value_${editConditionCounter}" placeholder="Value" id="edit_condition_value_${editConditionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditCondition(this)" ${editConditionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function addEditAction() {
    editActionCounter++;
    const container = document.getElementById('edit-actions-container');
    const newRow = document.createElement('div');
    newRow.className = 'edit-action-row mb-2';
    newRow.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-5">
                <select class="form-select" name="edit_action_type_${editActionCounter}" onchange="updateEditActionValue(this, ${editActionCounter})">
                    <option value="">Select Action</option>
                    <option value="mark_priority">Mark Priority</option>
                    <option value="escalate">Escalate</option>
                    <option value="notify">Notify</option>
                    <option value="block">Block Email</option>
                    <option value="flag">Add Flag</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="edit_action_value_${editActionCounter}" placeholder="Action Value" id="edit_action_value_${editActionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditAction(this)" ${editActionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function populateEditCondition(counter, condition, isFirst) {
    const fieldSelect = document.querySelector(`[name="edit_condition_field_${counter}"]`);
    const operatorSelect = document.querySelector(`[name="edit_condition_operator_${counter}"]`);
    const valueInput = document.querySelector(`[name="edit_condition_value_${counter}"]`);
    const logicSelect = document.querySelector(`[name="edit_condition_logic_${counter}"]`);

    if (fieldSelect) fieldSelect.value = condition.field || '';
    if (operatorSelect) operatorSelect.value = condition.operator || 'equals';
    if (valueInput) valueInput.value = condition.value || '';
    if (logicSelect && !isFirst) logicSelect.value = condition.logic || 'AND';
}

function populateEditAction(counter, action) {
    const typeSelect = document.querySelector(`[name="edit_action_type_${counter}"]`);
    const valueInput = document.querySelector(`[name="edit_action_value_${counter}"]`);

    if (typeSelect) typeSelect.value = action.type || '';
    if (valueInput) valueInput.value = action.value || '';
}

function updateEditConditionValue(selectElement, conditionId) {
    const fieldType = selectElement.value;
    const valueInput = document.getElementById(`edit_condition_value_${conditionId}`);

    if (fieldType === '_time') {
        valueInput.placeholder = 'Date/time (e.g., 2025-07-18 or 2025-07-18T12:00:00)';
    } else if (fieldType === 'sender') {
        valueInput.placeholder = 'Email address (e.g., user@domain.com)';
    } else if (fieldType === 'subject') {
        valueInput.placeholder = 'Text to match in subject';
    } else if (fieldType === 'attachments') {
        valueInput.placeholder = 'Attachment name or type (e.g., .pdf, document.docx)';
    } else if (fieldType === 'recipients') {
        valueInput.placeholder = 'Recipient email address';
    } else if (fieldType === 'recipients_email_domain') {
        valueInput.placeholder = 'Domain name (e.g., gmail.com)';
    } else if (fieldType === 'leaver') {
        valueInput.placeholder = 'YES or NO';
    } else if (fieldType === 'Termination') {
        valueInput.placeholder = 'Termination date (e.g., 2025-07)';
    } else if (fieldType === 'time_month') {
        valueInput.placeholder = 'Month in YYYY-MM format (e.g., 2025-07)';
    } else if (fieldType === 'account_type') {
        valueInput.placeholder = 'Account type (e.g., employee, contractor)';
    } else if (fieldType === 'wordlist_attachment' || fieldType === 'wordlist_subject') {
        valueInput.placeholder = 'Wordlist match value';
    } else if (fieldType === 'bunit') {
        valueInput.placeholder = 'Business unit (e.g., HR, IT, Finance)';
    } else if (fieldType === 'department') {
        valueInput.placeholder = 'Department name (e.g., Recruitment, Sales)';
    } else if (fieldType === 'status') {
        valueInput.placeholder = 'Email status (e.g., Active, Critical, Blocked)';
    } else if (fieldType === 'user_response') {
        valueInput.placeholder = 'User response value';
    } else if (fieldType === 'final_outcome') {
        valueInput.placeholder = 'Final outcome value';
    } else if (fieldType === 'policy_name') {
        valueInput.placeholder = 'Policy name (e.g., policy_A, policy_B)';
    } else {
        valueInput.placeholder = 'Value';
    }
}

function updateEditActionValue(selectEl, counter) {
    const valueInput = document.getElementById(`edit_action_value_${counter}`);
    const actionType = selectEl.value;

    if (actionType === 'mark_priority') {
        valueInput.placeholder = 'Low, Medium, High, Critical';
    } else if (actionType === 'escalate') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'notify') {
        valueInput.placeholder = 'Notification message';
    } else if (actionType === 'block') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'flag') {
        valueInput.placeholder = 'Flag name';
    } else {
        valueInput.placeholder = 'Action Value';
    }
}

function removeEditCondition(button) {
    const row = button.closest('.edit-condition-row');
    if (row) {
        row.remove();
        updateEditConditionLogicDisplay();
    }
}

function removeEditAction(button) {
    const row = button.closest('.edit-action-row');
    if (row) {
        row.remove();
    }
}

function updateEditConditionLogicDisplay() {
    const rows = document.querySelectorAll('.edit-condition-row');
    rows.forEach((row, index) => {
        const logicCol = row.querySelector('.col-md-1:first-child');
        if (index === 0) {
            // First condition shouldn't show logic
            logicCol.innerHTML = '';
        } else {
            // Ensure other conditions have logic selector
            if (!logicCol.querySelector('select')) {
                logicCol.innerHTML = `
                    <select class="form-select" name="edit_condition_logic_${index + 1}">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                `;
            }
        }
    });
}

function buildEditRuleData() {
    const conditions = [];
    const actions = [];

    // Build conditions
    const conditionRows = document.querySelectorAll('.edit-condition-row');
    conditionRows.forEach((row, index) => {
        const fieldEl = row.querySelector(`[name^="edit_condition_field_"]`);
        const operatorEl = row.querySelector(`[name^="edit_condition_operator_"]`);
        const valueEl = row.querySelector(`[name^="edit_condition_value_"]`);
        const logicEl = row.querySelector(`[name^="edit_condition_logic_"]`);

        if (fieldEl && operatorEl && valueEl && fieldEl.value && valueEl.value) {
            const condition = {
                field: fieldEl.value,
                operator: operatorEl.value,
                value: valueEl.value
            };

            // Add logic operator for conditions after the first one
            if (index > 0 && logicEl && logicEl.value) {
                condition.logic = logicEl.value;
            }

            conditions.push(condition);
        }
    });

    // Build actions
    const actionRows = document.querySelectorAll('.edit-action-row');
    actionRows.forEach((row) => {
        const typeEl = row.querySelector(`[name^="edit_action_type_"]`);
        const valueEl = row.querySelector(`[name^="edit_action_value_"]`);

        if (typeEl && valueEl && typeEl.value && valueEl.value) {
            let finalValue = valueEl.value;

            // Convert string boolean to actual boolean
            if (typeEl.value === 'escalate' && 
                (finalValue.toLowerCase() === 'true' || finalValue.toLowerCase() === 'false')) {
                finalValue = finalValue.toLowerCase() === 'true';
            }

            actions.push({
                type: typeEl.value,
                value: finalValue
            });
        }
    });

    // Set hidden fields
    document.getElementById('editConditions').value = JSON.stringify(conditions);
    document.getElementById('editActions').value = JSON.stringify(actions);
}

function decodeHTMLEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}
</script>
{% endblock %}