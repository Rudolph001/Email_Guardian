{% extends "base.html" %}

{% block title %}Email Guardian - Rules{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Rule Management</h1>
            <div>
                <button class="btn btn-secondary me-2" onclick="createExclusionRule()">
                    <i class="fas fa-filter me-2"></i>Create Exclusion Rule
                </button>
                <button class="btn btn-primary" onclick="createRule()">
                    <i class="fas fa-plus me-2"></i>Create Rule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rules Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|length }}</h5>
                        <p class="card-text text-muted">Total Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('active', 'equalto', true)|list|length }}</h5>
                        <p class="card-text text-muted">Active Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('priority', 'equalto', 1)|list|length }}</h5>
                        <p class="card-text text-muted">High Priority</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="card-title mb-0">{{ rules|selectattr('active', 'equalto', false)|list|length }}</h5>
                        <p class="card-text text-muted">Inactive Rules</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rules List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Processing Rules</h5>
            </div>
            <div class="card-body">
                {% if rules %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Description</th>
                                    <th>Priority</th>
                                    <th>Conditions</th>
                                    <th>Actions</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in rules %}
                                <tr class="{% if not rule.active %}table-secondary{% endif %}">
                                    <td>
                                        <strong>{{ rule.name }}</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ rule.description[:50] + '...' if rule.description and rule.description|length > 50 else rule.description or 'No description' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if rule.priority == 1 else 'warning' if rule.priority == 2 else 'info' }}">
                                            {{ rule.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ rule.conditions|length }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ rule.actions|length }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if rule.active else 'secondary' }}">
                                            {{ 'Active' if rule.active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ rule.created_at[:19] if rule.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                            <div class="d-flex gap-1">
                                <button class="btn btn-outline-primary btn-sm" 
                                        data-rule-id="{{ rule.id }}"
                                        data-rule-name="{{ rule.name }}"
                                        data-rule-description="{{ rule.description or '' }}"
                                        data-rule-conditions='{{ rule.conditions|tojson }}'
                                        data-rule-actions='{{ rule.actions|tojson }}'
                                        data-rule-priority="{{ rule.priority }}"
                                        onclick="viewRuleFromData(this)" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" 
                                        data-rule-id="{{ rule.id }}"
                                        data-rule-name="{{ rule.name }}"
                                        data-rule-description="{{ rule.description or '' }}"
                                        data-rule-conditions='{{ rule.conditions|tojson }}'
                                        data-rule-actions='{{ rule.actions|tojson }}'
                                        data-rule-priority="{{ rule.priority }}"
                                        data-rule-active="{{ rule.active|lower }}"
                                        onclick="editRuleFromData(this)" 
                                        title="Edit Rule">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_rule', rule_id=rule.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this rule?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Rule">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                        <h5>No Rules Configured</h5>
                        <p class="text-muted">Create your first rule to start automated email processing.</p>
                        <button class="btn btn-primary" onclick="createRule()">
                            <i class="fas fa-plus me-2"></i>Create First Rule
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Exclusion Rules Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Exclusion Rules
                    <small class="text-muted ms-2">(Filter records before import processing)</small>
                </h5>
            </div>
            <div class="card-body">
                <div id="exclusionRulesContainer">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading exclusion rules...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exclusion Rule Modal -->
<div class="modal fade" id="exclusionRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Exclusion Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exclusionRuleForm">
                    <div class="mb-3">
                        <label for="exclusionRuleName" class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="exclusionRuleName" required>
                    </div>
                    <div class="mb-3">
                        <label for="exclusionRuleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="exclusionRuleDescription" rows="2"></textarea>
                    </div>

                    <!-- Conditions Section -->
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            <span>Conditions</span>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addExclusionCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </label>
                        <div id="exclusionConditionsContainer">
                            <!-- Conditions will be added here -->
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="exclusionRuleCaseSensitive">
                        <label class="form-check-label" for="exclusionRuleCaseSensitive">
                            Case Sensitive
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveExclusionRule()">Create Rule</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for exclusion rules
let exclusionRulesData = [];
let fieldNames = {};
let conditionCounter = 0;

// Load exclusion rules on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExclusionRules();
});

// Function to create exclusion rule
function createExclusionRule() {
    // Load field names first
    fetch('/api/exclusion-rules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store field names globally
                fieldNames = data.field_names;

                // Reset form for new rule
                setupExclusionRuleModal(false);

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('exclusionRuleModal'));
                modal.show();
            } else {
                showAlert('Error loading field names: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to load exclusion rule form', 'error');
        });
}

// Function to setup exclusion rule modal for create or edit mode
function setupExclusionRuleModal(isEdit, rule = null, conditions = null, fieldNamesData = null) {
    if (fieldNamesData) {
        fieldNames = fieldNamesData;
    }

    // Clear the form
    document.getElementById('exclusionRuleName').value = isEdit && rule ? rule.name : '';
    document.getElementById('exclusionRuleDescription').value = isEdit && rule ? (rule.description || '') : '';
    document.getElementById('exclusionRuleCaseSensitive').checked = isEdit && rule ? rule.case_sensitive : false;

    // Update modal title and button
    const modalTitle = document.querySelector('#exclusionRuleModal .modal-title');
    const saveButton = document.querySelector('#exclusionRuleModal .btn-primary');

    if (isEdit) {
        modalTitle.textContent = 'Edit Exclusion Rule';
        saveButton.textContent = 'Update Rule';
        saveButton.setAttribute('onclick', `updateExclusionRule(${rule.id})`);
        window.currentEditingRule = rule;
    } else {
        modalTitle.textContent = 'Create Exclusion Rule';
        saveButton.textContent = 'Create Rule';
        saveButton.setAttribute('onclick', 'saveExclusionRule()');
        window.currentEditingRule = null;
    }

    // Clear and setup conditions
    conditionCounter = 0;
    document.getElementById('exclusionConditionsContainer').innerHTML = '';

    if (isEdit && conditions && conditions.length > 0) {
        // Add existing conditions for editing
        conditions.forEach((condition, index) => {
            addExclusionCondition(condition);
        });
    } else {
        // Add first empty condition for new rule
        addExclusionCondition();
    }
}

// Function to add exclusion condition
function addExclusionCondition(existingCondition = null) {
    conditionCounter++;
    const container = document.getElementById('exclusionConditionsContainer');

    const conditionDiv = document.createElement('div');
    conditionDiv.className = 'condition-row border rounded p-3 mb-2';
    conditionDiv.setAttribute('data-condition-id', conditionCounter);

    // Create field options with categories
    let fieldOptions = '<option value="">Select field...</option>';

    // Add categorized field options
    if (fieldNames.imported_fields) {
        fieldOptions += '<optgroup label="Imported Fields">';
        fieldNames.imported_fields.forEach(field => {
            fieldOptions += `<option value="${field}">${field}</option>`;
        });
        fieldOptions += '</optgroup>';
    }

    if (fieldNames.ml_fields) {
        fieldOptions += '<optgroup label="ML Analysis Fields">';
        fieldNames.ml_fields.forEach(field => {
            fieldOptions += `<option value="${field}">${field}</option>`;
        });
        fieldOptions += '</optgroup>';
    }

    if (fieldNames.risk_fields) {
        fieldOptions += '<optgroup label="Risk Assessment Fields">';
        fieldNames.risk_fields.forEach(field => {
            fieldOptions += `<option value="${field}">${field}</option>`;
        });
        fieldOptions += '</optgroup>';
    }

    // Logic selector for subsequent conditions
    const logicSelector = conditionCounter > 1 ? `
        <div class="col-md-2">
            <label class="form-label">Logic</label>
            <select class="form-select condition-logic">
                <option value="AND" ${existingCondition && existingCondition.logic === 'AND' ? 'selected' : ''}>AND</option>
                <option value="OR" ${existingCondition && existingCondition.logic === 'OR' ? 'selected' : ''}>OR</option>
            </select>
        </div>
    ` : '<div class="col-md-2"></div>';

    conditionDiv.innerHTML = `
        <div class="row g-2">
            ${logicSelector}
            <div class="col-md-3">
                <label class="form-label">Field</label>
                <select class="form-select condition-field" required>
                    ${fieldOptions}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Operator</label>
                <select class="form-select condition-operator" required>
                    <option value="">Select operator...</option>
                    <option value="equals" ${existingCondition && existingCondition.operator === 'equals' ? 'selected' : ''}>Equals</option>
                    <option value="contains" ${existingCondition && existingCondition.operator === 'contains' ? 'selected' : ''}>Contains</option>
                    <option value="not_equals" ${existingCondition && existingCondition.operator === 'not_equals' ? 'selected' : ''}>Not Equals</option>
                    <option value="starts_with" ${existingCondition && existingCondition.operator === 'starts_with' ? 'selected' : ''}>Starts With</option>
                    <option value="ends_with" ${existingCondition && existingCondition.operator === 'ends_with' ? 'selected' : ''}>Ends With</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Value</label>
                <input type="text" class="form-control condition-value" placeholder="Enter value..." value="${existingCondition ? existingCondition.value : ''}" required>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeExclusionCondition(${conditionCounter})" title="Remove condition">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

    container.appendChild(conditionDiv);

    // Set the selected field value if editing
    if (existingCondition && existingCondition.field) {
        const fieldSelect = conditionDiv.querySelector('.condition-field');
        fieldSelect.value = existingCondition.field;
    }
}

// Function to remove exclusion condition
function removeExclusionCondition(conditionId) {
    const conditionRow = document.querySelector(`[data-condition-id="${conditionId}"]`);
    if (conditionRow) {
        conditionRow.remove();

        // If this was the first condition and there are others, remove logic selector from new first condition
        const remainingConditions = document.querySelectorAll('.condition-row');
        if (remainingConditions.length > 0) {
            const firstCondition = remainingConditions[0];
            const logicColumn = firstCondition.querySelector('.col-md-2');
            if (logicColumn && logicColumn.querySelector('.condition-logic')) {
                logicColumn.innerHTML = '';
            }
        }
    }

    // Ensure at least one condition exists
    if (document.querySelectorAll('.condition-row').length === 0) {
        addExclusionCondition();
    }
}

// Function to save exclusion rule
function saveExclusionRule() {
    const name = document.getElementById('exclusionRuleName').value;
    const description = document.getElementById('exclusionRuleDescription').value;
    const caseSensitive = document.getElementById('exclusionRuleCaseSensitive').checked;

    // Collect all conditions
    const conditions = [];
    const conditionRows = document.querySelectorAll('.condition-row');

    conditionRows.forEach((row, index) => {
        const conditionId = row.getAttribute('data-condition-id');
        const logic = index === 0 ? 'AND' : (row.querySelector('.condition-logic')?.value || 'AND');
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;

        if (field && operator && value) {
            conditions.push({
                field: field,
                operator: operator,
                value: value,
                logic: logic
            });
        }
    });

    // Validate
    if (!name) {
        showAlert('Please enter a rule name', 'error');
        return;
    }

    if (conditions.length === 0) {
        showAlert('Please add at least one valid condition', 'error');
        return;
    }

    const formData = {
        name: name,
        description: description,
        conditions: conditions,
        case_sensitive: caseSensitive
    };

    fetch('/api/exclusion-rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Exclusion rule created successfully!', 'success');

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('exclusionRuleModal'));
            modal.hide();
            document.getElementById('exclusionRuleForm').reset();
            document.getElementById('exclusionConditionsContainer').innerHTML = '';

            // Reload exclusion rules
            loadExclusionRules();
        } else {
            showAlert('Error creating exclusion rule: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to create exclusion rule', 'error');
    });
}

// Function to update existing exclusion rule
function updateExclusionRule(ruleId) {
    const name = document.getElementById('exclusionRuleName').value.trim();
    const description = document.getElementById('exclusionRuleDescription').value.trim();
    const caseSensitive = document.getElementById('exclusionRuleCaseSensitive').checked;

    if (!name) {
        showAlert('Rule name is required', 'error');
        return;
    }

    // Collect conditions
    const conditions = [];
    const conditionRows = document.querySelectorAll('.condition-row');

    if (conditionRows.length === 0) {
        showAlert('At least one condition is required', 'error');
        return;
    }

    conditionRows.forEach((row, index) => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value.trim();
        const logic = row.querySelector('.condition-logic') ? row.querySelector('.condition-logic').value : 'AND';

        if (!field || !operator || !value) {
            showAlert('All fields in each condition must be filled', 'error');
            return;
        }

        conditions.push({
            field: field,
            operator: operator,
            value: value,
            logic: logic
        });
    });

    if (conditions.length === 0) {
        return; // Validation failed
    }

    const ruleData = {
        name: name,
        description: description,
        conditions: conditions,
        case_sensitive: caseSensitive
    };

    fetch(`/api/exclusion-rules/${ruleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Exclusion rule updated successfully!', 'success');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('exclusionRuleModal'));
            modal.hide();

            // Clear form
            document.getElementById('exclusionRuleForm').reset();
            document.getElementById('exclusionConditionsContainer').innerHTML = '';

            // Reload exclusion rules
            loadExclusionRules();
        } else {
            showAlert('Error updating exclusion rule: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to update exclusion rule', 'error');
    });
}

// Function to load and display exclusion rules
function loadExclusionRules() {
    fetch('/api/exclusion-rules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                exclusionRulesData = data.exclusion_rules;
                displayExclusionRules(exclusionRulesData);
            } else {
                console.error('Error loading exclusion rules:', data.error);
                document.getElementById('exclusionRulesContainer').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading exclusion rules: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('exclusionRulesContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Failed to load exclusion rules
                </div>
            `;
        });
}

// Function to display exclusion rules
function displayExclusionRules(rules) {
    const container = document.getElementById('exclusionRulesContainer');

    if (!rules || rules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                <h5>No Exclusion Rules Configured</h5>
                <p class="text-muted">Create your first exclusion rule to filter records before import processing.</p>
                <button class="btn btn-primary" onclick="createExclusionRule()">
                    <i class="fas fa-plus me-2"></i>Create First Exclusion Rule
                </button>
            </div>
        `;
        return;
    }

    let html = `
        <div class="row">
            <div class="col-12 mb-3">
                <button class="btn btn-primary" onclick="createExclusionRule()">
                    <i class="fas fa-plus me-2"></i>Add Exclusion Rule
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Field</th>
                        <th>Operator</th>
                        <th>Value</th>
                        <th>Case Sensitive</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    rules.forEach(rule => {
        const statusBadge = rule.active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-secondary">Inactive</span>';

        html += `
            <tr>
                <td>
                    <strong>${rule.name}</strong>
                    <br><small class="text-muted">${rule.description || 'No description'}</small>
                </td>
                <td><code>${rule.field}</code></td>
                <td><span class="badge bg-info">${rule.operator}</span></td>
                <td><code>${rule.value}</code></td>
                <td>${rule.case_sensitive ? 'Yes' : 'No'}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="editExclusionRule(${rule.id})" 
                                title="Edit rule">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="toggleExclusionRule(${rule.id})" 
                                title="${rule.active ? 'Deactivate' : 'Activate'} rule">
                            <i class="fas fa-${rule.active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteExclusionRule(${rule.id})" 
                                title="Delete rule">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

// Function to toggle exclusion rule
function toggleExclusionRule(ruleId) {
    fetch(`/api/exclusion-rules/${ruleId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Exclusion rule status updated successfully!', 'success');
            loadExclusionRules();
        } else {
            showAlert('Error updating exclusion rule: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to update exclusion rule status', 'error');
    });
}

// Function to edit exclusion rule
function editExclusionRule(ruleId) {
    fetch(`/api/exclusion-rules/${ruleId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const rule = data.rule;
            const fieldNames = data.field_names;

            // Handle backward compatibility - convert old format to new format
            let conditions = rule.conditions || [];
            if (conditions.length === 0 && rule.field) {
                conditions = [{
                    field: rule.field,
                    operator: rule.operator || 'equals',
                    value: rule.value || '',
                    logic: 'AND'
                }];
            }

            // Setup modal for editing
            setupExclusionRuleModal(true, rule, conditions, fieldNames);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('exclusionRuleModal'));
            modal.show();
        } else {
            showAlert('Error loading exclusion rule: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to load exclusion rule', 'error');
    });
}

// Function to delete exclusion rule
function deleteExclusionRule(ruleId) {
    if (!confirm('Are you sure you want to delete this exclusion rule? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/exclusion-rules/${ruleId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Exclusion rule deleted successfully!', 'success');
            loadExclusionRules();
        } else {
            showAlert('Error deleting exclusion rule: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to delete exclusion rule', 'error');
    });
}

// Helper function to show alerts
function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());

    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas ${iconClass} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at the top of the page
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<!-- Rule Creation Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_rule') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ruleName" class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="ruleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="rulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="rulePriority" name="priority" required>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3" selected>3 (Medium)</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="ruleDescription" name="description" rows="2"></textarea>
                    </div>

                    <!-- Conditions Builder -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Conditions</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </div>
                        <div id="conditions-container">
                            <!-- Conditions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Add conditions that must be met for this rule to apply</small>
                    </div>

                    <!-- Actions Builder -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Actions</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addAction()">
                                <i class="fas fa-plus me-1"></i>Add Action
                            </button>
                        </div>
                        <div id="actions-container">
                            <!-- Actions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Define what happens when this rule is triggered</small>
                    </div>

                    <!-- Hidden fields for JSON data -->
                    <input type="hidden" id="conditions" name="conditions" value="[]">
                    <input type="hidden" id="actions" name="actions" value="[]">

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ruleActive" name="active" checked>
                        <label class="form-check-label" for="ruleActive">
                            Active Rule
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="buildRuleData()">Create Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rule View Modal -->
<div class="modal fade" id="viewRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rule Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ruleDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Rule Edit Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRuleForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="editRuleName" class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="editRuleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editRulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="editRulePriority" name="priority" required>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3">3 (Medium)</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editRuleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editRuleDescription" name="description" rows="2"></textarea>
                    </div>

                    <!-- Conditions Builder for Edit -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Conditions</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </div>
                        <div id="edit-conditions-container">
                            <!-- Conditions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Add conditions that must be met for this rule to apply</small>
                    </div>

                    <!-- Actions Builder for Edit -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Rule Actions</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addEditAction()">
                                <i class="fas fa-plus me-1"></i>Add Action
                            </button>
                        </div>
                        <div id="edit-actions-container">
                            <!-- Actions will be added here dynamically -->
                        </div>
                        <small class="text-muted">Define what happens when this rule is triggered</small>
                    </div>

                    <!-- Hidden fields for JSON data -->
                    <input type="hidden" id="editConditions" name="conditions" value="[]">
                    <input type="hidden" id="editActions" name="actions" value="[]">

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editRuleActive" name="active">
                        <label class="form-check-label" for="editRuleActive">
                            Active Rule
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="buildEditRuleData()">Update Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conditionCounter = 0;
let actionCounter = 0;
let editConditionCounter = 0;
let editActionCounter = 0;

function createRule() {
    // Reset counters and clear containers
    conditionCounter = 0;
    actionCounter = 0;
    document.getElementById('conditions-container').innerHTML = '';
    document.getElementById('actions-container').innerHTML = '';

    // Add a default condition
    addCondition();
    // Add a default action
    addAction();

    const modal = new bootstrap.Modal(document.getElementById('createRuleModal'));
    modal.show();
}

function addCondition() {
    conditionCounter++;
    const container = document.getElementById('conditions-container');
    const newRow = document.createElement('div');
    newRow.className = 'condition-row mb-2';

    // Show logic dropdown only for conditions after the first one
    const showLogic = conditionCounter > 1;

    newRow.innerHTML = `
        <div class="row align-items-center">
            ${showLogic ? `
            <div class="col-md-1">
                <select class="form-select" name="condition_logic_${conditionCounter}">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
            </div>` : '<div class="col-md-1"></div>'}
            <div class="col-md-4">
                <select class="form-select" name="condition_field_${conditionCounter}" onchange="updateConditionValue(this, ${conditionCounter})">
                    <option value="">Select Field</option>
                    <option value="_time">Time</option>
                    <option value="sender">Sender</option>
                    <option value="subject">Subject</option>
                    <option value="attachments">Attachments</option>
                    <option value="recipients">Recipients</option>
                    <option value="recipients_email_domain">Recipient Domain</option>
                    <option value="leaver">Leaver Status</option>
                    <option value="termination_date">Termination Date</option>
                    <option value="time_month">Time Month</option>
                    <option value="account_type">Account Type</option>
                    <option value="wordlist_attachment">Attachment Wordlist</option>
                    <option value="wordlist_subject">Subject Wordlist</option>
                    <option value="bunit">Business Unit</option>
                    <option value="department">Department</option>
                    <option value="status">Email Status</option>
                    <option value="user_response">User Response</option>
                    <option value="final_outcome">Final Outcome</option>
                    <option value="policy_name">Policy Name</option>
                    <option value="ml_risk_level">Risk Level</option>
                                        <option value="justification">Justification</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="condition_operator_${conditionCounter}" onchange="updateConditionOperator(this, ${conditionCounter})">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="in_list">In List (comma-separated)</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="condition_value_${conditionCounter}" placeholder="Value" id="condition_value_${conditionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)" ${conditionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function updateConditionValue(selectElement, conditionId) {
    const fieldType = selectElement.value;
    const valueInput = document.getElementById(`condition_value_${conditionId}`);

    if (fieldType === '_time') {
        valueInput.placeholder = 'Date/time (e.g., 2025-07-18 or 2025-07-18T12:00:00)';
    } else if (fieldType === 'sender') {
        valueInput.placeholder = 'Email address (e.g., user@domain.com)';
    } else if (fieldType === 'subject') {
        valueInput.placeholder = 'Text to match in subject';
    } else if (fieldType === 'attachments') {
        valueInput.placeholder = 'Attachment name or type (e.g., .pdf, document.docx)';
    } else if (fieldType === 'recipients') {
        valueInput.placeholder = 'Recipient email address';
    } else if (fieldType === 'recipients_email_domain') {
        valueInput.placeholder = 'Domain name (e.g., gmail.com)';
    } else if (fieldType === 'leaver') {
        valueInput.placeholder = 'YES or NO';
    } else if (fieldType === 'Termination') {
        valueInput.placeholder = 'Termination date (e.g., 2025-07)';
    } else if (fieldType === 'time_month') {
        valueInput.placeholder = 'Month in YYYY-MM format (e.g., 2025-07)';
    } else if (fieldType === 'account_type') {
        valueInput.placeholder = 'Account type (e.g., employee, contractor)';
    } else if (fieldType === 'wordlist_attachment' || fieldType === 'wordlist_subject') {
        valueInput.placeholder = 'Wordlist match value';
    } else if (fieldType === 'bunit') {
        valueInput.placeholder = 'Business unit (e.g., HR, IT, Finance)';
    } else if (fieldType === 'department') {
        valueInput.placeholder = 'Department name (e.g., Recruitment, Sales)';
    } else if (fieldType === 'status') {
        valueInput.placeholder = 'Email status (e.g., Active, Critical, Blocked)';
    } else if (fieldType === 'user_response') {
        valueInput.placeholder = 'User response value';
    } else if (fieldType === 'final_outcome') {
        valueInput.placeholder = 'Final outcome value';
    } else if (fieldType === 'policy_name') {
        valueInput.placeholder = 'Policy name (e.g., policy_A, policy_B)';
    } else if (fieldType === 'ml_risk_level') {
        valueInput.placeholder = 'Risk level (Low, Medium, High, Critical)';
    } else {
        valueInput.placeholder = 'Value';
    }
}

function updateConditionOperator(selectElement, conditionId) {
    updateConditionOperatorHelp(conditionId);
}

function updateConditionOperatorHelp(conditionId) {
    const operatorSelect = document.querySelector(`select[name="condition_operator_${conditionId}"]`);
    const valueHelp = document.getElementById(`condition_value_help_${conditionId}`);

    if (!operatorSelect || !valueHelp) return;

    const operator = operatorSelect.value;

    switch (operator) {
        case 'equals':
            valueHelp.textContent = 'Enter a single value';
            break;
        case 'contains':
            valueHelp.textContent = 'Enter text to search for within the field';
            break;
        case 'not_equals':
            valueHelp.textContent = 'Enter a single value to exclude';
            break;
        case 'in_list':
            valueHelp.textContent = 'Enter multiple values separated by commas (e.g., value1, value2, value3)';
            break;
        default:
            valueHelp.textContent = 'Enter a value';
    }
}

function removeCondition(button) {
    const row = button.closest('.condition-row');
    if (row) {
        row.remove();
        // Update logic display for remaining conditions
        updateConditionLogicDisplay();
    }
}

function updateConditionLogicDisplay() {
    const rows = document.querySelectorAll('.condition-row');
    rows.forEach((row, index) => {
        const logicCol = row.querySelector('.col-md-1:first-child');
        if (index === 0) {
            // First condition shouldn't show logic
            logicCol.innerHTML = '';
        } else {
            // Ensure other conditions have logic selector
            if (!logicCol.querySelector('select')) {
                logicCol.innerHTML = `
                    <select class="form-select" name="condition_logic_${index + 1}">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                `;
            }
        }
    });
}

function addAction() {
    actionCounter++;
    const container = document.getElementById('actions-container');
    const newRow = document.createElement('div');
    newRow.className = 'action-row mb-2';
    newRow.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-5">
                <select class="form-select" name="action_type_${actionCounter}" onchange="updateActionValue(this, ${actionCounter})">
                    <option value="">Select Action</option>
                    <option value="mark_priority">Mark Priority</option>
                    <option value="escalate">Escalate</option>
                    <option value="notify">Notify</option>
                    <option value="block">Block Email</option>
                    <option value="flag">Add Flag</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="action_value_${actionCounter}" placeholder="Action Value" id="action_value_${actionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAction(this)" ${actionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function removeAction(button) {
    const row = button.closest('.action-row');
    if (row) {
        row.remove();
    }
}

function updateActionValue(selectEl, counter) {
    const valueInput = document.getElementById(`action_value_${counter}`);
    const actionType = selectEl.value;

    if (actionType === 'mark_priority') {
        valueInput.placeholder = 'Low, Medium, High, Critical';
    } else if (actionType === 'escalate') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'notify') {
        valueInput.placeholder = 'Notification message';
    } else if (actionType === 'block') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'flag') {
        valueInput.placeholder = 'Flag name';
    } else {
        valueInput.placeholder = 'Action Value';
    }
}

function buildRuleData() {
    const conditions = [];
    const actions = [];

    // Build conditions
    const conditionRows = document.querySelectorAll('.condition-row');
    conditionRows.forEach((row, index) => {
        const fieldEl = row.querySelector(`[name^="condition_field_"]`);
        const operatorEl = row.querySelector(`[name^="condition_operator_"]`);
        const valueEl = row.querySelector(`[name^="condition_value_"]`);
        const logicEl = row.querySelector(`[name^="condition_logic_"]`);

        if (fieldEl && operatorEl && valueEl && fieldEl.value && valueEl.value) {
            const condition = {
                field: fieldEl.value,
                operator: operatorEl.value,
                value: valueEl.value
            };

            // Add logic operator for conditions after the first one
            if (index > 0 && logicEl && logicEl.value) {
                condition.logic = logicEl.value;
            }

            conditions.push(condition);
        }
    });

    // Build actions
    const actionRows = document.querySelectorAll('.action-row');
    actionRows.forEach((row) => {
        const typeEl = row.querySelector(`[name^="action_type_"]`);
        const valueEl = row.querySelector(`[name^="action_value_"]`);

        if (typeEl && valueEl && typeEl.value && valueEl.value) {
            let finalValue = valueEl.value;

            // Convert string boolean to actual boolean
            if (typeEl.value === 'escalate' && 
                (finalValue.toLowerCase() === 'true' || finalValue.toLowerCase() === 'false')) {
                finalValue = finalValue.toLowerCase() === 'true';
            }

            actions.push({
                type: typeEl.value,
                value: finalValue
            });
        }
    });

    // Set hidden fields
    document.getElementById('conditions').value = JSON.stringify(conditions);
    document.getElementById('actions').value = JSON.stringify(actions);
}

function viewRuleFromData(button) {
    try {
        const id = button.dataset.ruleId;
        const name = button.dataset.ruleName;
        const description = button.dataset.ruleDescription;

        // Parse JSON directly since we're using single quotes now
        const conditions = JSON.parse(button.dataset.ruleConditions || '[]');
        const actions = JSON.parse(button.dataset.ruleActions || '[]');
        const priority = button.dataset.rulePriority;

        viewRule(id, name, description, conditions, actions, priority);
    } catch (error) {
        console.error('Error viewing rule:', error);
        console.error('Conditions data:', button.dataset.ruleConditions);
        console.error('Actions data:', button.dataset.ruleActions);
        alert('Error viewing rule: ' + error.message);
    }
}

function editRuleFromData(button) {
    try {
        const id = button.dataset.ruleId;
        const name = button.dataset.ruleName;
        const description = button.dataset.ruleDescription;

        // Parse JSON directly since we're using single quotes now
        const conditions = JSON.parse(button.dataset.ruleConditions || '[]');
        const actions = JSON.parse(button.dataset.ruleActions || '[]');
        const priority = button.dataset.rulePriority;
        const active = button.dataset.ruleActive === 'true';

        editRule(id, name, description, conditions, actions, priority, active);
    } catch (error) {
        console.error('Error editing rule:', error);
        console.error('Conditions data:', button.dataset.ruleConditions);
        console.error('Actions data:', button.dataset.ruleActions);
        alert('Error editing rule: ' + error.message);
    }
}

function viewRule(id, name, description, conditions, actions, priority) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><strong>Rule Name:</strong></h6>
                <p>${name}</p>

                <h6><strong>Description:</strong></h6>
                <p>${description || 'No description provided'}</p>

                <h6><strong>Priority:</strong></h6>
                <p>${priority}</p>
            </div>
            <div class="col-md-6">
                <h6><strong>Conditions:</strong></h6>
                <pre class="bg-light p-2 border rounded">${JSON.stringify(conditions, null, 2)}</pre>

                <h6><strong>Actions:</strong></h6>
                <pre class="bg-light p-2 border rounded">${JSON.stringify(actions, null, 2)}</pre>
            </div>
        </div>
    `;

    document.getElementById('ruleDetailsContent').innerHTML = content;
    const modal = new bootstrap.Modal(document.getElementById('viewRuleModal'));
    modal.show();
}

function editRule(id, name, description, conditions, actions, priority, active) {
    // Reset counters and clear containers
    editConditionCounter = 0;
    editActionCounter = 0;
    document.getElementById('edit-conditions-container').innerHTML = '';
    document.getElementById('edit-actions-container').innerHTML = '';

    // Populate the edit form
    document.getElementById('editRuleName').value = name;
    document.getElementById('editRuleDescription').value = description || '';
    document.getElementById('editRulePriority').value = priority;
    document.getElementById('editRuleActive').checked = active;

    // Build conditions from JSON
    if (conditions && conditions.length > 0) {
        conditions.forEach((condition, index) => {
            addEditCondition();
            populateEditCondition(editConditionCounter, condition, index === 0);
        });
    } else {
        addEditCondition();
    }

    // Build actions from JSON
    if (actions && actions.length > 0) {
        actions.forEach((action) => {
            addEditAction();
            populateEditAction(editActionCounter, action);
        });
    } else {
        addEditAction();
    }

    // Set the form action to update this specific rule
    document.getElementById('editRuleForm').action = `/rules/${id}/update`;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editRuleModal'));
    modal.show();
}

function addEditCondition() {
    editConditionCounter++;
    const container = document.getElementById('edit-conditions-container');
    const newRow = document.createElement('div');
    newRow.className = 'edit-condition-row mb-2';

    // Show logic dropdown only for conditions after the first one
    const showLogic = editConditionCounter > 1;

    newRow.innerHTML = `
        <div class="row align-items-center">
            ${showLogic ? `
            <div class="col-md-1">
                <select class="form-select" name="edit_condition_logic_${editConditionCounter}">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
            </div>` : '<div class="col-md-1"></div>'}
            <div class="col-md-4">
                <select class="form-select" name="edit_condition_field_${editConditionCounter}" onchange="updateEditConditionValue(this, ${editConditionCounter})">
                    <option value="">Select Field</option>
                    <option value="_time">Time</option>
                    <option value="sender">Sender</option>
                    <option value="subject">Subject</option>
                    <option value="attachments">Attachments</option>
                    <option value="recipients">Recipients</option>
                    <option value="recipients_email_domain">Recipient Domain</option>
                    <option value="leaver">Leaver Status</option>
                    <option value="termination_date">Termination Date</option>
                    <option value="time_month">Time Month</option>
                    <option value="account_type">Account Type</option>
                    <option value="wordlist_attachment">Attachment Wordlist</option>
                    <option value="wordlist_subject">Subject Wordlist</option>
                    <option value="bunit">Business Unit</option>
                    <option value="department">Department</option>
                    <option value="status">Email Status</option>
                    <option value="user_response">User Response</option>
                    <option value="final_outcome">Final Outcome</option>
                    <option value="policy_name">Policy Name</option>
                    <option value="ml_risk_level">Risk Level</option>
                                        <option value="justification">Justification</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="edit_condition_operator_${editConditionCounter}">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="in_list">In List (comma-separated)</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="edit_condition_value_${editConditionCounter}" placeholder="Value" id="edit_condition_value_${editConditionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditCondition(this)" ${editConditionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function addEditAction() {
    editActionCounter++;
    const container = document.getElementById('edit-actions-container');
    const newRow = document.createElement('div');
    newRow.className = 'edit-action-row mb-2';
    newRow.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-5">
                <select class="form-select" name="edit_action_type_${editActionCounter}" onchange="updateEditActionValue(this, ${editActionCounter})">
                    <option value="">Select Action</option>
                    <option value="mark_priority">Mark Priority</option>
                    <option value="escalate">Escalate</option>
                    <option value="notify">Notify</option>
                    <option value="block">Block Email</option>
                    <option value="flag">Add Flag</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="edit_action_value_${editActionCounter}" placeholder="Action Value" id="edit_action_value_${editActionCounter}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditAction(this)" ${editActionCounter === 1 ? 'style="visibility: hidden;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function populateEditCondition(counter, condition, isFirst) {
    const fieldSelect = document.querySelector(`[name="edit_condition_field_${counter}"]`);
    const operatorSelect = document.querySelector(`[name="edit_condition_operator_${counter}"]`);
    const valueInput = document.querySelector(`[name="edit_condition_value_${counter}"]`);
    const logicSelect = document.querySelector(`[name="edit_condition_logic_${counter}"]`);

    if (fieldSelect) fieldSelect.value = condition.field || '';
    if (operatorSelect) operatorSelect.value = condition.operator || 'equals';
    if (valueInput) valueInput.value = condition.value || '';
    if (logicSelect && !isFirst) logicSelect.value = condition.logic || 'AND';
}

function populateEditAction(counter, action) {
    const typeSelect = document.querySelector(`[name="edit_action_type_${counter}"]`);
    const valueInput = document.querySelector(`[name="edit_action_value_${counter}"]`);

    if (typeSelect) typeSelect.value = action.type || '';
    if (valueInput) valueInput.value = action.value || '';
}

function updateEditConditionValue(selectElement, conditionId) {
    const fieldType = selectElement.value;
    const valueInput = document.getElementById(`edit_condition_value_${conditionId}`);

    if (fieldType === '_time') {
        valueInput.placeholder = 'Date/time (e.g., 2025-07-18 or 2025-07-18T12:00:00)';
    } else if (fieldType === 'sender') {
        valueInput.placeholder = 'Email address (e.g., user@domain.com)';
    } else if (fieldType === 'subject') {
        valueInput.placeholder = 'Text to match in subject';
    } else if (fieldType === 'attachments') {
        valueInput.placeholder = 'Attachment name or type (e.g., .pdf, document.docx)';
    } else if (fieldType === 'recipients') {
        valueInput.placeholder = 'Recipient email address';
    } else if (fieldType === 'recipients_email_domain') {
        valueInput.placeholder = 'Domain name (e.g., gmail.com)';
    } else if (fieldType === 'leaver') {
        valueInput.placeholder = 'YES or NO';
    } else if (fieldType === 'Termination') {
        valueInput.placeholder = 'Termination date (e.g., 2025-07)';
    } else if (fieldType === 'time_month') {
        valueInput.placeholder = 'Month in YYYY-MM format (e.g., 2025-07)';
    } else if (fieldType === 'account_type') {
        valueInput.placeholder = 'Account type (e.g., employee, contractor)';
    } else if (fieldType === 'wordlist_attachment' || fieldType === 'wordlist_subject') {
        valueInput.placeholder = 'Wordlist match value';
    } else if (fieldType === 'bunit') {
        valueInput.placeholder = 'Business unit (e.g., HR, IT, Finance)';
    } else if (fieldType === 'department') {
        valueInput.placeholder = 'Department name (e.g., Recruitment, Sales)';
    } else if (fieldType === 'status') {
        valueInput.placeholder = 'Email status (e.g., Active, Critical, Blocked)';
    } else if (fieldType === 'user_response') {
        valueInput.placeholder = 'User response value';
    } else if (fieldType === 'final_outcome') {
        valueInput.placeholder = 'Final outcome value';
    } else if (fieldType === 'policy_name') {
        valueInput.placeholder = 'Policy name (e.g., policy_A, policy_B)';
    } else if (fieldType === 'ml_risk_level') {
        valueInput.placeholder = 'Risk level (Low, Medium, High, Critical)';
    } else {
        valueInput.placeholder = 'Value';
    }
}

function updateEditActionValue(selectEl, counter) {
    const valueInput = document.getElementById(`edit_action_value_${counter}`);
    const actionType = selectEl.value;

    if (actionType === 'mark_priority') {
        valueInput.placeholder = 'Low, Medium, High, Critical';
    } else if (actionType === 'escalate') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'notify') {
        valueInput.placeholder = 'Notification message';
    } else if (actionType === 'block') {
        valueInput.placeholder = 'true or false';
    } else if (actionType === 'flag') {
        valueInput.placeholder = 'Flag name';
    } else {
        valueInput.placeholder = 'Action Value';
    }
}

function removeEditCondition(button) {
    const row = button.closest('.edit-condition-row');
    if (row) {
        row.remove();
        updateEditConditionLogicDisplay();
    }
}

function removeEditAction(button) {
    const row = button.closest('.edit-action-row');
    if (row) {
        row.remove();
    }
}

function updateEditConditionLogicDisplay() {
    const rows = document.querySelectorAll('.edit-condition-row');
    rows.forEach((row, index) => {
        const logicCol = row.querySelector('.col-md-1:first-child');
        if (index === 0) {
            // First condition shouldn't show logic
            logicCol.innerHTML = '';
        } else {
            // Ensure other conditions have logic selector
            if (!logicCol.querySelector('select')) {
                logicCol.innerHTML = `
                    <select class="form-select" name="edit_condition_logic_${index + 1}">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                `;
            }
        }
    });
}

function buildEditRuleData() {
    const conditions = [];
    const actions = [];

    // Build conditions
    const conditionRows = document.querySelectorAll('.edit-condition-row');
    conditionRows.forEach((row, index) => {
        const fieldEl = row.querySelector(`[name^="edit_condition_field_"]`);
        const operatorEl = row.querySelector(`[name^="edit_condition_operator_"]`);
        const valueEl = row.querySelector(`[name^="edit_condition_value_"]`);
        const logicEl = row.querySelector(`[name^="edit_condition_logic_"]`);

        if (fieldEl && operatorEl && valueEl && fieldEl.value && valueEl.value) {
            const condition = {
                field: fieldEl.value,
                operator: operatorEl.value,
                value: valueEl.value
            };

            // Add logic operator for conditions after the first one
            if (index > 0 && logicEl && logicEl.value) {
                condition.logic = logicEl.value;
            }

            conditions.push(condition);
        }
    });

    // Build actions
    const actionRows = document.querySelectorAll('.edit-action-row');
    actionRows.forEach((row) => {
        const typeEl = row.querySelector(`[name^="edit_action_type_"]`);
        const valueEl = row.querySelector(`[name^="edit_action_value_"]`);

        if (typeEl && valueEl && typeEl.value && valueEl.value) {
            let finalValue = valueEl.value;

            // Convert string boolean to actual boolean
            if (typeEl.value === 'escalate' && 
                (finalValue.toLowerCase() === 'true' || finalValue.toLowerCase() === 'false')) {
                finalValue = finalValue.toLowerCase() === 'true';
            }

            actions.push({
                type: typeEl.value,
                value: finalValue
            });
        }
    });

    // Set hidden fields
    document.getElementById('editConditions').value = JSON.stringify(conditions);
    document.getElementById('editActions').value = JSON.stringify(actions);
}

function decodeHTMLEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}
</script>
{% endblock %}