{% extends "base.html" %}

{% block title %}Email Guardian - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">Administration Panel</h1>
    </div>
</div>

<!-- Whitelist Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Whitelist Domains
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('update_whitelist') }}">
                    <div class="mb-3">
                        <label for="domains" class="form-label">Trusted Domains</label>
                        <textarea class="form-control" id="domains" name="domains" rows="8" 
                                  placeholder="Enter one domain per line">{% for domain in whitelists.domains %}{{ domain }}
{% endfor %}</textarea>
                        <div class="form-text">
                            Emails from these domains will be filtered out from analysis. Enter one domain per line.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Whitelist
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Whitelist Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Current Domains</h6>
                    <span class="badge bg-primary">{{ whitelists.domains|length }}</span>
                </div>
                
                <div class="mb-3">
                    <h6>Last Updated</h6>
                    <small class="text-muted">{{ whitelists.updated_at[:19] }}</small>
                </div>
                
                <div class="mb-3">
                    <h6>Domain Examples</h6>
                    <ul class="list-unstyled">
                        {% for domain in whitelists.domains[:5] %}
                        <li><code>{{ domain }}</code></li>
                        {% endfor %}
                        {% if whitelists.domains|length > 5 %}
                        <li><small class="text-muted">... and {{ whitelists.domains|length - 5 }} more</small></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attachment Keywords Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-paperclip me-2"></i>Attachment Analysis Keywords
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('update_attachment_keywords') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="business_keywords" class="form-label">
                                    <i class="fas fa-briefcase me-1"></i>Business Keywords
                                </label>
                                <textarea class="form-control" id="business_keywords" name="business_keywords" rows="8" 
                                          placeholder="Enter one keyword per line">{% for keyword in attachment_keywords.business_keywords %}{{ keyword }}
{% endfor %}</textarea>
                                <div class="form-text">
                                    Keywords that indicate business-related attachments
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="personal_keywords" class="form-label">
                                    <i class="fas fa-user me-1"></i>Personal Keywords
                                </label>
                                <textarea class="form-control" id="personal_keywords" name="personal_keywords" rows="8" 
                                          placeholder="Enter one keyword per line">{% for keyword in attachment_keywords.personal_keywords %}{{ keyword }}
{% endfor %}</textarea>
                                <div class="form-text">
                                    Keywords that indicate personal attachments
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="suspicious_keywords" class="form-label">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Suspicious Keywords
                                </label>
                                <textarea class="form-control" id="suspicious_keywords" name="suspicious_keywords" rows="8" 
                                          placeholder="Enter one keyword per line">{% for keyword in attachment_keywords.suspicious_keywords %}{{ keyword }}
{% endfor %}</textarea>
                                <div class="form-text">
                                    Keywords that indicate potentially suspicious attachments
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Attachment Keywords
                            </button>
                            <small class="text-muted ms-3">
                                Last updated: {{ attachment_keywords.updated_at[:19] if attachment_keywords.updated_at else 'Never' }}
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Attachment Analysis Statistics -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-briefcase me-2"></i>Business Keywords
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Total Keywords:</strong>
                    <span class="badge bg-primary">{{ attachment_keywords.business_keywords|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Examples:</strong>
                    <ul class="list-unstyled">
                        {% for keyword in attachment_keywords.business_keywords[:3] %}
                        <li><code>{{ keyword }}</code></li>
                        {% endfor %}
                        {% if attachment_keywords.business_keywords|length > 3 %}
                        <li><small class="text-muted">... and {{ attachment_keywords.business_keywords|length - 3 }} more</small></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>Personal Keywords
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Total Keywords:</strong>
                    <span class="badge bg-warning">{{ attachment_keywords.personal_keywords|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Examples:</strong>
                    <ul class="list-unstyled">
                        {% for keyword in attachment_keywords.personal_keywords[:3] %}
                        <li><code>{{ keyword }}</code></li>
                        {% endfor %}
                        {% if attachment_keywords.personal_keywords|length > 3 %}
                        <li><small class="text-muted">... and {{ attachment_keywords.personal_keywords|length - 3 }} more</small></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Suspicious Keywords
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Total Keywords:</strong>
                    <span class="badge bg-danger">{{ attachment_keywords.suspicious_keywords|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Examples:</strong>
                    <ul class="list-unstyled">
                        {% for keyword in attachment_keywords.suspicious_keywords[:3] %}
                        <li><code>{{ keyword }}</code></li>
                        {% endfor %}
                        {% if attachment_keywords.suspicious_keywords|length > 3 %}
                        <li><small class="text-muted">... and {{ attachment_keywords.suspicious_keywords|length - 3 }} more</small></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Session Management
                </h5>
            </div>
            <div class="card-body">
                {% if sessions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Session ID</th>
                                    <th>Filename</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Created</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sessions %}
                                <tr>
                                    <td>
                                        <code>{{ session.session_id }}</code>
                                    </td>
                                    <td>{{ session.filename }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if session.status == 'active' else 'secondary' }}">
                                            {{ session.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px; width: 100px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ (session.processed_records / session.total_records * 100) if session.total_records > 0 else 0 }}%">
                                                {{ session.processed_records or 0 }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ session.created_at[:19] }}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ "%.1f"|format((session.processed_data|length * 1024) / 1024) }} KB
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('dashboard', session_id=session.session_id) }}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('export_session', session_id=session.session_id) }}" 
                                               class="btn btn-outline-success">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('delete_session', session_id=session.session_id) }}" 
                                                  style="display: inline;" 
                                                  onsubmit="return confirm('Are you sure you want to delete session {{ session.session_id }}? This action cannot be undone.')">
                                                <button type="submit" class="btn btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h5>No Sessions Found</h5>
                        <p class="text-muted">No processing sessions have been created yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">System Status</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>ML Engine:</strong>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="mb-2">
                    <strong>Rule Engine:</strong>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="mb-2">
                    <strong>Storage:</strong>
                    <span class="badge bg-success">Available</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Processing Statistics</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Total Sessions:</strong>
                    <span class="badge bg-info">{{ sessions|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Active Sessions:</strong>
                    <span class="badge bg-success">{{ sessions|selectattr('status', 'equalto', 'active')|list|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Total Records:</strong>
                    <span class="badge bg-primary">{{ sessions|sum(attribute='processed_records') or 0 }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Configuration</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Whitelisted Domains:</strong>
                    <span class="badge bg-info">{{ whitelists.domains|length }}</span>
                </div>
                <div class="mb-2">
                    <strong>Upload Limit:</strong>
                    <span class="badge bg-secondary">16 MB</span>
                </div>
                <div class="mb-2">
                    <strong>Data Retention:</strong>
                    <span class="badge bg-secondary">Persistent</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
        // In a real implementation, this would make a DELETE request
        alert('Session deletion would be implemented here');
    }
}
</script>
{% endblock %}
